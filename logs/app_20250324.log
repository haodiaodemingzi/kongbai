[2025-03-24 12:02:31,419] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 12:02:31,423] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 12:02:31,610] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 12:02:31,721] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 12:02:31,735] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 12:02:31,736] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 12:02:31,755] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 12:02:31,756] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 12:02:31,756] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 12:02:36,344] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:02:36,345] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 12:02:36,353] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:02:51,142] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:02:51,143] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 12:02:51,154] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:09:02,132] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:09:02,133] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 12:09:02,139] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:09:09,975] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:09:09,976] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 12:09:09,988] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:09:14,381] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:09:14,382] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：湿婆, 限制数量：30
[2025-03-24 12:09:14,389] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:09:18,733] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:09:18,733] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 12:09:18,740] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:09:20,096] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:09:20,096] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 12:09:20,104] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:09:24,949] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:09:24,949] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 12:09:24,958] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:09:31,945] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:09:31,945] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 12:09:31,953] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:09:33,811] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:09:33,812] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 12:09:33,820] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:10:01,316] [INFO] [battle:player_details:150] - 访问玩家详情页面，玩家ID: 1039
[2025-03-24 12:10:01,317] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 12:10:01,354] [INFO] [data_service:get_battle_details_by_player:322] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 12:12:19,777] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 12:12:19,783] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 12:12:19,940] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 12:12:20,027] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 12:12:20,038] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 12:12:20,039] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 12:12:20,056] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 12:12:20,056] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 12:12:20,057] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 12:13:14,644] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:13:14,645] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 12:13:14,652] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:13:21,126] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:13:21,126] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：湿婆, 限制数量：30
[2025-03-24 12:13:21,136] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:13:22,616] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:13:22,617] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 12:13:22,625] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:13:24,640] [INFO] [battle:player_details:150] - 访问玩家详情页面，玩家ID: 1039
[2025-03-24 12:13:24,641] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 12:13:24,674] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 12:13:24,703] [WARNING] [battle:player_details:157] - 找不到ID为 1039 的玩家
[2025-03-24 12:13:25,023] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:13:25,023] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 12:13:25,031] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:13:32,583] [INFO] [battle:player_details:150] - 访问玩家详情页面，玩家ID: 1039
[2025-03-24 12:13:32,583] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 12:13:32,598] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 12:13:32,618] [WARNING] [battle:player_details:157] - 找不到ID为 1039 的玩家
[2025-03-24 12:13:32,944] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:13:32,945] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 12:13:32,952] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:13:37,402] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:13:37,403] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 12:13:37,414] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 12:13:38,900] [INFO] [battle:player_details:150] - 访问玩家详情页面，玩家ID: 36
[2025-03-24 12:13:38,901] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 36 的战斗明细
[2025-03-24 12:13:38,911] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 36}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 36}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 12:13:38,931] [WARNING] [battle:player_details:157] - 找不到ID为 36 的玩家
[2025-03-24 12:13:39,252] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 12:13:39,252] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 12:13:39,259] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:02:01,678] [INFO] [battle:player_details:150] - 访问玩家详情页面，玩家ID: 1039
[2025-03-24 14:02:01,678] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:02:01,693] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:02:01,717] [WARNING] [battle:player_details:157] - 找不到ID为 1039 的玩家
[2025-03-24 14:02:01,940] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:02:01,940] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:02:01,949] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:02:12,802] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:02:12,803] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 14:02:12,811] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:02:14,491] [INFO] [battle:player_details:150] - 访问玩家详情页面，玩家ID: 36
[2025-03-24 14:02:14,491] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 36 的战斗明细
[2025-03-24 14:02:14,503] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 36}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 36}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:02:14,531] [WARNING] [battle:player_details:157] - 找不到ID为 36 的玩家
[2025-03-24 14:02:14,848] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:02:14,849] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:02:14,857] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:19:59,872] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 14:19:59,877] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 14:20:00,192] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 14:20:00,376] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 14:20:00,410] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 14:20:00,411] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 14:20:00,441] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 14:20:00,441] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 14:20:00,441] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 14:21:51,691] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 14:22:06,174] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 14:22:06,175] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 14:22:06,188] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 14:22:06,193] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 14:22:06,194] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 14:22:06,194] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 14:22:06,196] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 14:22:06,201] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 14:22:06,201] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 14:22:06,202] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 14:22:06,220] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 14:22:06,263] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 14:22:06,264] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 14:22:06,264] [ERROR] [battle:upload_file:98] - 保存到数据库时发生异常: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 90, in upload_file
    save_success, save_message = save_battle_log_to_db(battle_details, blessings)
                                 ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
[2025-03-24 14:22:06,597] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:22:06,598] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:22:06,609] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:22:17,972] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:22:17,973] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 14:22:17,980] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:22:24,191] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:22:24,192] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 14:22:24,198] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:22:30,418] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:22:30,419] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：湿婆, 限制数量：30
[2025-03-24 14:22:30,426] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:22:31,989] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:22:31,991] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 14:22:32,005] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:22:34,868] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:22:34,886] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:22:35,250] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:22:35,251] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:22:35,260] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:22:40,158] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:22:40,173] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:22:40,506] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:22:40,507] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:22:40,515] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:22:56,435] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 36 的战斗明细
[2025-03-24 14:22:56,442] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 36}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 36}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:22:56,773] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:22:56,773] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:22:56,781] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:27:57,917] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:27:57,918] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:27:57,926] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:29:26,246] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:29:26,247] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:29:26,262] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:29:29,121] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:29:29,137] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:29:29,504] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:29:29,505] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:29:29,522] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:29:41,780] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:29:41,795] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:29:42,168] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:29:42,169] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:29:42,176] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:33:05,624] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:33:50,248] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:33:50,271] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 302, 处理时间: 57071ms
[2025-03-24 14:33:50,286] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:33:50,287] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:33:50,299] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:34:05,814] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:36:19,179] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:36:19,197] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 302, 处理时间: 138039ms
[2025-03-24 14:36:19,512] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:36:19,513] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:36:19,521] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:36:38,775] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:37:14,828] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:37:19,663] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 302, 处理时间: 44789ms
[2025-03-24 14:37:19,679] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:37:19,681] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:37:19,692] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:37:27,223] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:37:37,247] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:37:43,032] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 302, 处理时间: 18622ms
[2025-03-24 14:37:43,352] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:37:43,352] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:37:43,360] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:37:50,464] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:38:11,053] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:38:28,472] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 302, 处理时间: 40433ms
[2025-03-24 14:38:28,488] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:38:28,489] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:38:28,507] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:38:34,817] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:38:58,409] [ERROR] [data_service:get_battle_details_by_player:388] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 343, in get_battle_details_by_player
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:39:21,405] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 14:39:21,414] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 14:39:21,556] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 14:39:21,653] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 14:39:21,666] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 14:39:21,666] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 14:39:21,691] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 14:39:21,692] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 14:39:21,692] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 14:39:25,211] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:39:25,708] [ERROR] [data_service:get_battle_details_by_player:392] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 344, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:39:25,743] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 302, 处理时间: 4005ms
[2025-03-24 14:39:25,758] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:39:25,759] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:39:25,773] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:39:36,785] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:39:44,260] [ERROR] [data_service:get_battle_details_by_player:392] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 344, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 14:40:39,083] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 14:40:39,092] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 14:40:39,404] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 14:40:39,620] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 14:40:39,650] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 14:40:39,651] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 14:40:39,687] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 14:40:39,688] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 14:40:39,688] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 14:41:02,858] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 14:41:02,859] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 14:41:02,867] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 14:41:02,869] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_144102.csv
[2025-03-24 14:41:02,870] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 14:41:02,871] [ERROR] [battle:report:314] - 生成报告时出错: too many values to unpack (expected 3)
[2025-03-24 14:41:02,873] [CRITICAL] [__init__:handle_exception:105] - 未处理的异常: Could not build url for endpoint 'main.index'. Did you mean 'home.index' instead?
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 230, in report
    report_data, god_stats, stats_summary = generate_battle_report(
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: too many values to unpack (expected 3)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\routes\battle.py", line 315, in report
    return redirect(url_for('main.index'))
                    ~~~~~~~^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\helpers.py", line 256, in url_for
    return current_app.url_for(
           ~~~~~~~~~~~~~~~~~~~^
        endpoint,
        ^^^^^^^^^
    ...<4 lines>...
        **values,
        ^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2034, in url_for
    return self.handle_url_build_error(error, endpoint, values)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 917, in build
    raise BuildError(endpoint, values, method, self)
werkzeug.routing.exceptions.BuildError: Could not build url for endpoint 'main.index'. Did you mean 'home.index' instead?
[2025-03-24 14:41:06,983] [WARNING] [__init__:page_not_found:94] - 404 错误: /players, 来源: http://localhost:5000/
[2025-03-24 14:41:10,912] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 14:41:23,659] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 14:41:23,660] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 14:41:23,669] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 14:41:23,671] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 14:41:23,672] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 14:41:23,673] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 14:41:23,673] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 14:41:23,676] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 14:41:23,677] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 14:41:23,677] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 14:41:23,689] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 14:41:23,717] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 14:41:23,717] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 14:41:23,717] [ERROR] [battle:upload_file:98] - 保存到数据库时发生异常: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 90, in upload_file
    save_success, save_message = save_battle_log_to_db(battle_details, blessings)
                                 ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
[2025-03-24 14:41:24,041] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 14:41:24,041] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 14:41:24,054] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 14:41:33,700] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:41:33,700] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 14:41:39,135] [ERROR] [data_service:get_battle_details_by_player:392] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 344, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 15:08:17,822] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 15:08:17,823] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 15:08:17,834] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 15:08:30,652] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 302, 处理时间: 1667344ms
[2025-03-24 15:08:30,653] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 15:08:30,654] [ERROR] [data_service:get_battle_details_by_player:392] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 344, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 15:08:30,686] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 302, 处理时间: 1622337ms
[2025-03-24 15:08:42,705] [ERROR] [data_service:get_battle_details_by_player:392] - 获取玩家战斗明细时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.victim_id' in 'on clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\utils\data_service.py", line 344, in get_battle_details_by_player
    kills_details = db.session.execute(text(kills_details_sql), {"person_id": person_id}).fetchall()
                    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.victim_id' in 'on clause'")
[SQL: 
        SELECT 
            v.id AS victim_id,
            v.name AS victim_name,
            v.job AS victim_job,
            v.god AS victim_god,
            COUNT(*) AS kill_count
        FROM 
            battle_record br
        JOIN 
            person v ON br.victim_id = v.id
        WHERE 
            br.create_by = %(person_id)s
            AND br.win > 0
        GROUP BY 
            v.id, v.name, v.job, v.god
        ORDER BY 
            kill_count DESC
        LIMIT 20
        ]
[parameters: {'person_id': 1039}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 15:10:10,286] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 302, 处理时间: 107177ms
[2025-03-24 15:10:10,603] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 15:10:10,604] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 15:10:10,613] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 15:10:20,106] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 15:11:46,613] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 15:11:46,621] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 15:11:46,858] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 15:11:47,034] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 15:11:47,048] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 15:11:47,049] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 15:11:47,083] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 15:11:47,084] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 15:11:47,085] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 15:12:05,142] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 15:12:05,210] [INFO] [data_service:get_battle_details_by_player:388] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 15:12:05,334] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/player/1039, 状态码: 200, 处理时间: 16866ms
[2025-03-24 15:14:21,634] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 15:14:21,635] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 15:14:21,646] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 15:14:25,517] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 15:14:25,535] [INFO] [data_service:get_battle_details_by_player:388] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 15:14:29,876] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 15:14:41,986] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 15:14:41,986] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 15:14:41,997] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 15:14:42,002] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:14:42,002] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:14:42,002] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:14:42,003] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 15:14:42,006] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 15:14:42,006] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 15:14:42,006] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 15:18:14,859] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:18:14,872] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:18:14,872] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 15:18:14,872] [ERROR] [battle:upload_file:98] - 保存到数据库时发生异常: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 90, in upload_file
    save_success, save_message = save_battle_log_to_db(battle_details, blessings)
                                 ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
[2025-03-24 15:18:14,879] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/upload, 状态码: 302, 处理时间: 212893ms
[2025-03-24 15:18:15,202] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 15:18:15,203] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 15:18:15,213] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 15:19:58,688] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 15:20:07,064] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 15:20:07,064] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 15:20:07,074] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 15:20:07,076] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:20:07,077] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:20:07,077] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:20:07,078] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 15:20:07,082] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 15:20:07,083] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 15:20:07,083] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 15:20:11,919] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:20:11,923] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:20:11,924] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 15:22:34,852] [ERROR] [battle:upload_file:98] - 保存到数据库时发生异常: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 90, in upload_file
    save_success, save_message = save_battle_log_to_db(battle_details, blessings)
                                 ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
[2025-03-24 15:22:34,856] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/upload, 状态码: 302, 处理时间: 147793ms
[2025-03-24 15:22:35,177] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 15:22:35,178] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 15:22:35,187] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 15:22:51,093] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 15:22:51,098] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 15:22:51,234] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 15:22:51,328] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 15:22:51,339] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 15:22:51,340] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 15:22:51,364] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 15:22:51,364] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 15:22:51,365] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 15:22:55,769] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 15:23:05,147] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 15:23:05,148] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 15:23:05,156] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 15:23:05,161] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:23:05,162] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:23:05,162] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:23:05,163] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 15:23:05,167] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 15:23:05,168] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 15:23:05,169] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 15:23:05,185] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:23:05,223] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:23:05,223] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 15:23:22,123] [ERROR] [battle:upload_file:98] - 保存到数据库时发生异常: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 90, in upload_file
    save_success, save_message = save_battle_log_to_db(battle_details, blessings)
                                 ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: retry_on_deadlock.<locals>.decorator() takes 1 positional argument but 2 were given
[2025-03-24 15:23:54,919] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 15:23:54,924] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 15:23:55,104] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 15:23:55,275] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 15:23:55,291] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 15:23:55,292] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 15:23:55,367] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 15:23:55,368] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 15:23:55,369] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 15:24:02,769] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 15:24:02,770] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 15:24:02,779] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 15:24:02,781] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:24:02,782] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:24:02,782] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:24:02,783] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 15:24:02,787] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 15:24:02,788] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 15:24:02,789] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 15:24:02,805] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:24:02,847] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:24:02,847] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 15:24:14,092] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 15:24:22,595] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 15:24:22,595] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 15:24:22,603] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 15:24:22,605] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:24:22,606] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:24:22,606] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 15:24:22,606] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 15:24:22,609] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 15:24:22,609] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 15:24:22,609] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 15:24:22,618] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:24:22,641] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 15:24:22,642] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 15:24:30,618] [INFO] [file_parser:save_battle_log_to_db:209] - 开始保存战斗日志到数据库: 582条击杀记录, 8条祝福记录
[2025-03-24 15:24:30,618] [INFO] [file_parser:save_battle_log_to_db:209] - 开始保存战斗日志到数据库: 582条击杀记录, 8条祝福记录
[2025-03-24 15:24:30,619] [INFO] [file_parser:save_battle_log_to_db:212] - 开始保存战斗日志到数据库
[2025-03-24 15:24:31,193] [INFO] [file_parser:save_battle_log_to_db:212] - 开始保存战斗日志到数据库
[2025-03-24 15:24:31,204] [INFO] [file_parser:save_battle_log_to_db:224] - 战斗日志中共涉及 41 名玩家
[2025-03-24 15:24:32,684] [INFO] [file_parser:save_battle_log_to_db:231] - 数据库中查询到 1036 名玩家记录
[2025-03-24 15:24:33,508] [INFO] [file_parser:save_battle_log_to_db:240] - 战斗日志中的玩家在数据库中找到 22/41 个，缺少 19 个
[2025-03-24 15:24:33,984] [WARNING] [file_parser:save_battle_log_to_db:244] - 大量玩家在数据库中不存在，缺少 19 个玩家记录
[2025-03-24 15:24:34,577] [INFO] [file_parser:save_battle_log_to_db:263] - 检查到 208 条已存在的战斗记录时间戳
[2025-03-24 15:24:34,772] [WARNING] [file_parser:save_battle_log_to_db:319] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 15:24:34,773] [WARNING] [file_parser:save_battle_log_to_db:317] - 击杀者 沿途有你 在数据库中不存在
[2025-03-24 15:24:34,774] [WARNING] [file_parser:save_battle_log_to_db:319] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 15:24:34,775] [WARNING] [file_parser:save_battle_log_to_db:319] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 15:24:34,775] [WARNING] [file_parser:save_battle_log_to_db:319] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 15:24:56,540] [INFO] [file_parser:save_battle_log_to_db:323] - 击杀记录处理完成：成功 0，错误 0，缺少玩家 368，跳过 214
[2025-03-24 15:24:56,548] [INFO] [file_parser:save_battle_log_to_db:339] - 检查到 0 条已存在的祝福记录时间戳
[2025-03-24 15:24:56,549] [WARNING] [file_parser:save_battle_log_to_db:365] - 祝福接收者 沿途有你 在数据库中不存在
[2025-03-24 15:24:56,549] [WARNING] [file_parser:save_battle_log_to_db:365] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 15:24:56,550] [WARNING] [file_parser:save_battle_log_to_db:365] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 15:24:56,550] [INFO] [file_parser:save_battle_log_to_db:224] - 战斗日志中共涉及 41 名玩家
[2025-03-24 15:24:56,550] [WARNING] [file_parser:save_battle_log_to_db:365] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 15:24:58,799] [INFO] [file_parser:save_battle_log_to_db:402] - 祝福记录处理完成：成功 4，错误 0，缺少玩家 4
[2025-03-24 15:24:58,800] [INFO] [file_parser:save_battle_log_to_db:431] - 生成战绩报告SQL:
[2025-03-24 15:24:58,801] [INFO] [file_parser:save_battle_log_to_db:432] - 
            SELECT 
                p.id AS player_id,
                p.name AS player_name,
                p.job AS player_job,
                p.god AS player_god,
                COUNT(CASE WHEN br.win != '0' THEN 1 END) AS kills,
                COUNT(CASE WHEN br.lost != '0' THEN 1 END) AS deaths,
                MAX(br.remark) AS blessings,
                CASE WHEN COUNT(CASE WHEN br.lost != '0' THEN 1 END) > 0 
                     THEN ROUND(COUNT(CASE WHEN br.win != '0' THEN 1 END) * 1.0 / COUNT(CASE WHEN br.lost != '0' THEN 1 END), 2) 
                     ELSE COUNT(CASE WHEN br.win != '0' THEN 1 END) END AS kd_ratio,
                (COUNT(CASE WHEN br.win != '0' THEN 1 END) * 3 + MAX(COALESCE(br.remark, 0)) - COUNT(CASE WHEN br.lost != '0' THEN 1 END)) AS score,
                MAX(br.position) AS last_position,
                MAX(br.publish_at) AS last_battle_time,
                p.updated_at AS last_updated
            FROM 
                person p
            LEFT JOIN 
                battle_record br ON p.id = br.create_by
            GROUP BY
                p.id, p.name, p.job, p.god, p.updated_at
            ORDER BY 
                score DESC, kills DESC, deaths ASC;
            
[2025-03-24 15:24:58,804] [INFO] [file_parser:save_battle_log_to_db:438] - 战斗日志保存完成，总处理时间: 27.61 秒
[2025-03-24 15:24:58,805] [INFO] [battle:upload_file:92] - 数据保存成功: 处理完成：0 条击杀记录，4 条祝福记录
[2025-03-24 15:24:58,809] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/upload, 状态码: 302, 处理时间: 36215ms
[2025-03-24 15:24:59,129] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 15:24:59,130] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 15:24:59,142] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 15:25:00,374] [INFO] [file_parser:save_battle_log_to_db:231] - 数据库中查询到 1036 名玩家记录
[2025-03-24 15:25:16,722] [INFO] [file_parser:save_battle_log_to_db:240] - 战斗日志中的玩家在数据库中找到 22/41 个，缺少 19 个
[2025-03-24 15:25:16,722] [WARNING] [file_parser:save_battle_log_to_db:244] - 大量玩家在数据库中不存在，缺少 19 个玩家记录
[2025-03-24 15:25:18,289] [INFO] [file_parser:save_battle_log_to_db:263] - 检查到 208 条已存在的战斗记录时间戳
[2025-03-24 16:15:27,620] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 16:15:27,624] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 16:15:27,822] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 16:15:28,006] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 16:15:28,027] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 16:15:28,028] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 16:15:28,062] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 16:15:28,064] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 16:15:28,064] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 16:15:50,163] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:15:50,164] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:15:50,188] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 16:15:56,468] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 16:16:03,053] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 16:16:03,053] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 16:16:03,064] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 16:16:03,069] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 16:16:03,070] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 16:16:03,071] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 16:16:03,072] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 16:16:03,076] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 16:16:03,077] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 16:16:03,077] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 16:16:03,090] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 16:16:03,142] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 16:16:03,143] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 16:16:20,814] [INFO] [file_parser:save_battle_log_to_db:209] - 开始保存战斗日志到数据库: 582条击杀记录, 8条祝福记录
[2025-03-24 16:16:21,043] [INFO] [file_parser:save_battle_log_to_db:212] - 开始保存战斗日志到数据库
[2025-03-24 16:16:27,468] [INFO] [file_parser:save_battle_log_to_db:224] - 战斗日志中共涉及 41 名玩家
[2025-03-24 16:16:30,841] [INFO] [file_parser:save_battle_log_to_db:231] - 数据库中查询到 1036 名玩家记录
[2025-03-24 16:16:37,965] [INFO] [file_parser:save_battle_log_to_db:240] - 战斗日志中的玩家在数据库中找到 22/41 个，缺少 19 个
[2025-03-24 16:16:37,965] [WARNING] [file_parser:save_battle_log_to_db:244] - 大量玩家在数据库中不存在，缺少 19 个玩家记录
[2025-03-24 16:16:39,474] [INFO] [file_parser:save_battle_log_to_db:263] - 检查到 0 条已存在的战斗记录时间戳
[2025-03-24 16:17:27,057] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 16:17:48,844] [WARNING] [file_parser:save_battle_log_to_db:306] - 击杀者 沿途有你 在数据库中不存在
[2025-03-24 16:17:48,847] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 16:17:48,848] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 16:17:48,849] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 16:17:49,125] [INFO] [file_parser:save_battle_log_to_db:312] - 战斗记录处理完成：成功 211，错误 0，缺少玩家 371，跳过 0
[2025-03-24 16:18:06,822] [INFO] [file_parser:save_battle_log_to_db:328] - 检查到 0 条已存在的祝福记录时间戳
[2025-03-24 16:18:15,291] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 沿途有你 在数据库中不存在
[2025-03-24 16:18:27,137] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 16:18:27,138] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 16:18:27,139] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 16:19:24,647] [INFO] [file_parser:save_battle_log_to_db:386] - 祝福记录处理完成：成功 4，错误 0，缺少玩家 4
[2025-03-24 16:19:27,061] [INFO] [file_parser:save_battle_log_to_db:433] - 生成战绩报告SQL:
[2025-03-24 16:19:27,418] [INFO] [file_parser:save_battle_log_to_db:434] - 
            WITH player_stats AS (
                SELECT 
                    p.id,
                    p.name,
                    p.job,
                    p.god,
                    -- 统计击杀次数(通过win字段关联)
                    COUNT(DISTINCT CASE WHEN br.win = p.name THEN br.id END) as kills,
                    -- 统计死亡次数(通过lost字段关联)
                    COUNT(DISTINCT CASE WHEN br.lost = p.name THEN br.id END) as deaths,
                    -- 统计祝福次数(只有win的玩家才会有祝福)
                    SUM(CASE WHEN br.win = p.name THEN COALESCE(br.remark, 0) ELSE 0 END) as blessings,
                    -- 获取最后战斗位置和时间
                    MAX(br.position) as last_position,
                    MAX(br.publish_at) as last_battle_time
                FROM 
                    person p
                LEFT JOIN 
                    battle_record br ON br.win = p.name OR br.lost = p.name
                WHERE 1=1
                GROUP BY 
                    p.id, p.name, p.job, p.god
            )
            SELECT 
                id as player_id,
                name as player_name,
                job as player_job,
                god as player_god,
                kills,
                deaths,
                blessings,
                CASE WHEN deaths > 0 
                     THEN ROUND(CAST(kills AS FLOAT) / deaths, 2) 
                     ELSE kills END as kd_ratio,
                (kills * 3 + blessings - deaths) as score,
                last_position,
                last_battle_time
            FROM 
                player_stats
            ORDER BY 
                score DESC, kills DESC, deaths ASC;
            
[2025-03-24 16:19:28,467] [INFO] [file_parser:save_battle_log_to_db:440] - 战斗日志保存完成，总处理时间: 186.75 秒
[2025-03-24 16:19:32,516] [INFO] [battle:upload_file:92] - 数据保存成功: 处理完成：211 条战斗记录，4 条祝福记录
[2025-03-24 16:19:35,878] [WARNING] [__init__:after_request:83] - 请求处理缓慢: /battle/upload, 状态码: 302, 处理时间: 212826ms
[2025-03-24 16:19:36,207] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:19:36,207] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:19:36,221] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 16:19:54,784] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 16:19:54,817] [INFO] [data_service:get_battle_details_by_player:410] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 16:24:39,284] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:24:39,284] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:24:39,293] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 16:24:49,323] [INFO] [data_service:get_battle_details_by_player:220] - 获取玩家ID 1039 的战斗明细
[2025-03-24 16:24:49,345] [INFO] [data_service:get_battle_details_by_player:410] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 16:27:25,037] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:27:25,038] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:27:25,050] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 16:27:27,722] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:27:27,723] [INFO] [data_service:get_player_rankings:142] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:27:27,733] [INFO] [data_service:get_player_rankings:210] - 返回 30 名玩家的排名数据
[2025-03-24 16:27:34,681] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 16:27:34,690] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 16:27:34,902] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 16:27:35,030] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 16:27:35,044] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 16:27:35,044] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 16:27:35,066] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 16:27:35,068] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 16:27:35,068] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 16:27:38,269] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:27:38,270] [INFO] [data_service:get_player_rankings:165] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:27:38,301] [INFO] [data_service:get_player_rankings:252] - 返回 30 名玩家的排名数据
[2025-03-24 16:27:40,923] [INFO] [data_service:get_battle_details_by_player:262] - 获取玩家ID 1039 的战斗明细
[2025-03-24 16:27:40,986] [INFO] [data_service:get_battle_details_by_player:452] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 16:27:48,711] [INFO] [data_service:get_battle_details_by_player:262] - 获取玩家ID 1039 的战斗明细
[2025-03-24 16:27:48,735] [INFO] [data_service:get_battle_details_by_player:452] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 16:30:32,880] [INFO] [data_service:get_battle_details_by_player:262] - 获取玩家ID 1039 的战斗明细
[2025-03-24 16:30:32,898] [INFO] [data_service:get_battle_details_by_player:452] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 16:30:42,480] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 16:30:42,483] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 16:30:42,644] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 16:30:42,740] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 16:30:42,751] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 16:30:42,752] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 16:30:42,779] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 16:30:42,780] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 16:30:42,781] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 16:30:46,904] [INFO] [data_service:get_battle_details_by_player:262] - 获取玩家ID 1039 的战斗明细
[2025-03-24 16:30:46,956] [INFO] [data_service:get_battle_details_by_player:453] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 16:31:21,847] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:31:21,848] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:31:21,851] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:31:21,851] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_163121.csv
[2025-03-24 16:31:21,852] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.00 秒
[2025-03-24 16:31:21,853] [ERROR] [battle:report:314] - 生成报告时出错: too many values to unpack (expected 3)
[2025-03-24 16:31:21,854] [CRITICAL] [__init__:handle_exception:105] - 未处理的异常: Could not build url for endpoint 'main.index'. Did you mean 'home.index' instead?
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 230, in report
    report_data, god_stats, stats_summary = generate_battle_report(
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: too many values to unpack (expected 3)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\routes\battle.py", line 315, in report
    return redirect(url_for('main.index'))
                    ~~~~~~~^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\helpers.py", line 256, in url_for
    return current_app.url_for(
           ~~~~~~~~~~~~~~~~~~~^
        endpoint,
        ^^^^^^^^^
    ...<4 lines>...
        **values,
        ^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2034, in url_for
    return self.handle_url_build_error(error, endpoint, values)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 917, in build
    raise BuildError(endpoint, values, method, self)
werkzeug.routing.exceptions.BuildError: Could not build url for endpoint 'main.index'. Did you mean 'home.index' instead?
[2025-03-24 16:31:31,440] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 16:31:43,157] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 16:31:43,158] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 16:31:43,164] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 16:31:43,166] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 16:31:43,167] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 16:31:43,167] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 16:31:43,168] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 16:31:43,173] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 16:31:43,173] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 16:31:43,173] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 16:31:43,183] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 16:31:43,191] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 16:31:43,192] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 16:31:43,193] [INFO] [file_parser:save_battle_log_to_db:209] - 开始保存战斗日志到数据库: 582条击杀记录, 8条祝福记录
[2025-03-24 16:31:43,194] [INFO] [file_parser:save_battle_log_to_db:212] - 开始保存战斗日志到数据库
[2025-03-24 16:31:43,194] [INFO] [file_parser:save_battle_log_to_db:224] - 战斗日志中共涉及 41 名玩家
[2025-03-24 16:31:43,272] [INFO] [file_parser:save_battle_log_to_db:231] - 数据库中查询到 1036 名玩家记录
[2025-03-24 16:31:43,275] [INFO] [file_parser:save_battle_log_to_db:240] - 战斗日志中的玩家在数据库中找到 22/41 个，缺少 19 个
[2025-03-24 16:31:43,276] [WARNING] [file_parser:save_battle_log_to_db:244] - 大量玩家在数据库中不存在，缺少 19 个玩家记录
[2025-03-24 16:31:43,305] [INFO] [file_parser:save_battle_log_to_db:263] - 检查到 208 条已存在的战斗记录时间戳
[2025-03-24 16:31:43,305] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 16:31:43,306] [WARNING] [file_parser:save_battle_log_to_db:306] - 击杀者 沿途有你 在数据库中不存在
[2025-03-24 16:31:43,307] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 16:31:43,307] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 16:31:43,308] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 16:31:43,319] [INFO] [file_parser:save_battle_log_to_db:312] - 战斗记录处理完成：成功 0，错误 0，缺少玩家 368，跳过 214
[2025-03-24 16:31:43,325] [INFO] [file_parser:save_battle_log_to_db:328] - 检查到 4 条已存在的祝福记录时间戳
[2025-03-24 16:31:43,326] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 沿途有你 在数据库中不存在
[2025-03-24 16:31:43,326] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 16:31:43,327] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 16:31:43,327] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 16:31:43,335] [INFO] [file_parser:save_battle_log_to_db:386] - 祝福记录处理完成：成功 0，错误 0，缺少玩家 4
[2025-03-24 16:31:43,335] [INFO] [file_parser:save_battle_log_to_db:433] - 生成战绩报告SQL:
[2025-03-24 16:31:43,336] [INFO] [file_parser:save_battle_log_to_db:434] - 
            WITH player_stats AS (
                SELECT 
                    p.id,
                    p.name,
                    p.job,
                    p.god,
                    -- 统计击杀次数(通过win字段关联)
                    COUNT(DISTINCT CASE WHEN br.win = p.name THEN br.id END) as kills,
                    -- 统计死亡次数(通过lost字段关联)
                    COUNT(DISTINCT CASE WHEN br.lost = p.name THEN br.id END) as deaths,
                    -- 统计祝福次数(只有win的玩家才会有祝福)
                    SUM(CASE WHEN br.win = p.name THEN COALESCE(br.remark, 0) ELSE 0 END) as blessings,
                    -- 获取最后战斗位置和时间
                    MAX(br.position) as last_position,
                    MAX(br.publish_at) as last_battle_time
                FROM 
                    person p
                LEFT JOIN 
                    battle_record br ON br.win = p.name OR br.lost = p.name
                WHERE 1=1
                GROUP BY 
                    p.id, p.name, p.job, p.god
            )
            SELECT 
                id as player_id,
                name as player_name,
                job as player_job,
                god as player_god,
                kills,
                deaths,
                blessings,
                CASE WHEN deaths > 0 
                     THEN ROUND(CAST(kills AS FLOAT) / deaths, 2) 
                     ELSE kills END as kd_ratio,
                (kills * 3 + blessings - deaths) as score,
                last_position,
                last_battle_time
            FROM 
                player_stats
            ORDER BY 
                score DESC, kills DESC, deaths ASC;
            
[2025-03-24 16:31:43,338] [INFO] [file_parser:save_battle_log_to_db:440] - 战斗日志保存完成，总处理时间: 0.14 秒
[2025-03-24 16:31:43,341] [INFO] [battle:upload_file:92] - 数据保存成功: 处理完成：0 条战斗记录，0 条祝福记录
[2025-03-24 16:31:43,655] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:31:43,656] [INFO] [data_service:get_player_rankings:165] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:31:43,686] [INFO] [data_service:get_player_rankings:252] - 返回 30 名玩家的排名数据
[2025-03-24 16:31:59,394] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:31:59,395] [INFO] [data_service:get_player_rankings:165] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 16:31:59,415] [INFO] [data_service:get_player_rankings:252] - 返回 30 名玩家的排名数据
[2025-03-24 16:32:05,481] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:32:05,482] [INFO] [data_service:get_player_rankings:165] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 16:32:05,501] [INFO] [data_service:get_player_rankings:252] - 返回 30 名玩家的排名数据
[2025-03-24 16:34:54,837] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:34:54,838] [INFO] [data_service:get_player_rankings:165] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 16:34:54,853] [INFO] [data_service:get_player_rankings:252] - 返回 30 名玩家的排名数据
[2025-03-24 16:34:58,729] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:34:58,730] [INFO] [data_service:get_player_rankings:165] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 16:34:58,745] [INFO] [data_service:get_player_rankings:252] - 返回 30 名玩家的排名数据
[2025-03-24 16:35:13,838] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 16:35:13,844] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 16:35:13,976] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 16:35:14,067] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 16:35:14,082] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 16:35:14,083] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 16:35:14,118] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 16:35:14,118] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 16:35:14,119] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 16:35:14,140] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:35:14,141] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 16:35:14,153] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 16:35:21,813] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:35:21,814] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 16:35:21,828] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 16:35:26,064] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:35:26,064] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：湿婆, 限制数量：30
[2025-03-24 16:35:26,077] [INFO] [data_service:get_player_rankings:261] - 返回 1 名玩家的排名数据
[2025-03-24 16:35:28,805] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:35:28,806] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 16:35:28,820] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 16:35:30,902] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:35:30,904] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 16:35:30,917] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 16:35:42,955] [INFO] [data_service:get_battle_details_by_player:271] - 获取玩家ID 36 的战斗明细
[2025-03-24 16:35:43,004] [INFO] [data_service:get_battle_details_by_player:462] - 返回玩家 灬}域V随风灬 的战斗明细
[2025-03-24 16:36:52,713] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:36:52,714] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:36:52,719] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:36:52,721] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_163652.csv
[2025-03-24 16:36:52,722] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 16:36:52,723] [ERROR] [battle:report:314] - 生成报告时出错: too many values to unpack (expected 3)
[2025-03-24 16:36:52,726] [CRITICAL] [__init__:handle_exception:105] - 未处理的异常: Could not build url for endpoint 'main.index'. Did you mean 'home.index' instead?
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 230, in report
    report_data, god_stats, stats_summary = generate_battle_report(
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: too many values to unpack (expected 3)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\routes\battle.py", line 315, in report
    return redirect(url_for('main.index'))
                    ~~~~~~~^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\helpers.py", line 256, in url_for
    return current_app.url_for(
           ~~~~~~~~~~~~~~~~~~~^
        endpoint,
        ^^^^^^^^^
    ...<4 lines>...
        **values,
        ^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2034, in url_for
    return self.handle_url_build_error(error, endpoint, values)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 917, in build
    raise BuildError(endpoint, values, method, self)
werkzeug.routing.exceptions.BuildError: Could not build url for endpoint 'main.index'. Did you mean 'home.index' instead?
[2025-03-24 16:40:26,972] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:40:26,972] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:40:26,985] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:40:26,987] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_164026.csv
[2025-03-24 16:40:26,988] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.02 秒
[2025-03-24 16:40:26,989] [ERROR] [battle:report:314] - 生成报告时出错: too many values to unpack (expected 3)
[2025-03-24 16:40:26,993] [CRITICAL] [__init__:handle_exception:105] - 未处理的异常: Could not build url for endpoint 'main.index'. Did you mean 'home.index' instead?
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 230, in report
    csv_filename, report_data, god_stats, stats_summary = generate_battle_report(
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: too many values to unpack (expected 3)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\routes\battle.py", line 315, in report
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\helpers.py", line 256, in url_for
    return current_app.url_for(
           ~~~~~~~~~~~~~~~~~~~^
        endpoint,
        ^^^^^^^^^
    ...<4 lines>...
        **values,
        ^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2034, in url_for
    return self.handle_url_build_error(error, endpoint, values)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 917, in build
    raise BuildError(endpoint, values, method, self)
werkzeug.routing.exceptions.BuildError: Could not build url for endpoint 'main.index'. Did you mean 'home.index' instead?
[2025-03-24 16:40:40,511] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 16:40:40,516] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 16:40:40,683] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 16:40:40,793] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 16:40:40,804] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 16:40:40,804] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 16:40:40,826] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 16:40:40,826] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 16:40:40,827] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 16:40:40,985] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:40:40,986] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:40:40,989] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:40:40,990] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_164040.csv
[2025-03-24 16:40:40,990] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 16:40:40,991] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 16:40:41,227] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:40:41,227] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:40:41,230] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:40:41,230] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_164041.csv
[2025-03-24 16:40:41,231] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.00 秒
[2025-03-24 16:40:41,231] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 16:40:43,650] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:40:43,651] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:40:43,657] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:40:43,658] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_164043.csv
[2025-03-24 16:40:43,659] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 16:40:43,659] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 16:40:45,153] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:40:45,154] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:40:45,158] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:40:45,160] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_164045.csv
[2025-03-24 16:40:45,161] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 16:40:45,163] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 16:40:46,419] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:40:46,421] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:40:46,429] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:40:46,430] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_164046.csv
[2025-03-24 16:40:46,431] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 16:40:46,432] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 16:40:47,622] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:40:47,623] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:40:47,629] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:40:47,630] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_164047.csv
[2025-03-24 16:40:47,631] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 16:40:47,631] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 16:40:56,223] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:40:56,224] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:40:56,227] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:40:56,228] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_164056.csv
[2025-03-24 16:40:56,229] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 16:40:56,230] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 16:41:04,963] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 16:41:15,151] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 16:41:28,800] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 16:41:28,801] [INFO] [battle:upload_file:41] - 收到文件上传请求
[2025-03-24 16:41:28,811] [INFO] [battle:upload_file:56] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 16:41:28,816] [INFO] [battle:upload_file:69] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 16:41:28,816] [INFO] [battle:upload_file:76] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 16:41:28,817] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 16:41:28,818] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 16:41:28,820] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 16:41:28,820] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 16:41:28,822] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 16:41:28,832] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 16:41:28,862] [INFO] [battle:upload_file:86] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 16:41:28,862] [INFO] [battle:upload_file:88] - 开始将解析结果保存到数据库
[2025-03-24 16:41:28,863] [INFO] [file_parser:save_battle_log_to_db:209] - 开始保存战斗日志到数据库: 582条击杀记录, 8条祝福记录
[2025-03-24 16:41:28,863] [INFO] [file_parser:save_battle_log_to_db:212] - 开始保存战斗日志到数据库
[2025-03-24 16:41:28,863] [INFO] [file_parser:save_battle_log_to_db:224] - 战斗日志中共涉及 41 名玩家
[2025-03-24 16:41:28,949] [INFO] [file_parser:save_battle_log_to_db:231] - 数据库中查询到 1036 名玩家记录
[2025-03-24 16:41:28,954] [INFO] [file_parser:save_battle_log_to_db:240] - 战斗日志中的玩家在数据库中找到 22/41 个，缺少 19 个
[2025-03-24 16:41:28,955] [WARNING] [file_parser:save_battle_log_to_db:244] - 大量玩家在数据库中不存在，缺少 19 个玩家记录
[2025-03-24 16:41:29,003] [INFO] [file_parser:save_battle_log_to_db:263] - 检查到 208 条已存在的战斗记录时间戳
[2025-03-24 16:41:29,004] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 16:41:29,005] [WARNING] [file_parser:save_battle_log_to_db:306] - 击杀者 沿途有你 在数据库中不存在
[2025-03-24 16:41:29,005] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 16:41:29,006] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 16:41:29,006] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 16:41:29,018] [INFO] [file_parser:save_battle_log_to_db:312] - 战斗记录处理完成：成功 0，错误 0，缺少玩家 368，跳过 214
[2025-03-24 16:41:29,030] [INFO] [file_parser:save_battle_log_to_db:328] - 检查到 4 条已存在的祝福记录时间戳
[2025-03-24 16:41:29,030] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 沿途有你 在数据库中不存在
[2025-03-24 16:41:29,032] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 16:41:29,032] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 16:41:29,032] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 16:41:29,049] [INFO] [file_parser:save_battle_log_to_db:386] - 祝福记录处理完成：成功 0，错误 0，缺少玩家 4
[2025-03-24 16:41:29,049] [INFO] [file_parser:save_battle_log_to_db:433] - 生成战绩报告SQL:
[2025-03-24 16:41:29,050] [INFO] [file_parser:save_battle_log_to_db:434] - 
            WITH player_stats AS (
                SELECT 
                    p.id,
                    p.name,
                    p.job,
                    p.god,
                    -- 统计击杀次数(通过win字段关联)
                    COUNT(DISTINCT CASE WHEN br.win = p.name THEN br.id END) as kills,
                    -- 统计死亡次数(通过lost字段关联)
                    COUNT(DISTINCT CASE WHEN br.lost = p.name THEN br.id END) as deaths,
                    -- 统计祝福次数(只有win的玩家才会有祝福)
                    SUM(CASE WHEN br.win = p.name THEN COALESCE(br.remark, 0) ELSE 0 END) as blessings,
                    -- 获取最后战斗位置和时间
                    MAX(br.position) as last_position,
                    MAX(br.publish_at) as last_battle_time
                FROM 
                    person p
                LEFT JOIN 
                    battle_record br ON br.win = p.name OR br.lost = p.name
                WHERE 1=1
                GROUP BY 
                    p.id, p.name, p.job, p.god
            )
            SELECT 
                id as player_id,
                name as player_name,
                job as player_job,
                god as player_god,
                kills,
                deaths,
                blessings,
                CASE WHEN deaths > 0 
                     THEN ROUND(CAST(kills AS FLOAT) / deaths, 2) 
                     ELSE kills END as kd_ratio,
                (kills * 3 + blessings - deaths) as score,
                last_position,
                last_battle_time
            FROM 
                player_stats
            ORDER BY 
                score DESC, kills DESC, deaths ASC;
            
[2025-03-24 16:41:29,054] [INFO] [file_parser:save_battle_log_to_db:440] - 战斗日志保存完成，总处理时间: 0.19 秒
[2025-03-24 16:41:29,060] [INFO] [battle:upload_file:92] - 数据保存成功: 处理完成：0 条战斗记录，0 条祝福记录
[2025-03-24 16:41:29,380] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:41:29,380] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:41:29,411] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 16:41:37,185] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:41:37,186] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 16:41:37,199] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 16:41:41,240] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:41:41,241] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 16:41:41,257] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 16:41:46,817] [INFO] [battle:export_json:172] - 访问数据导出页面
[2025-03-24 16:41:46,818] [INFO] [data_service:export_data_to_json:472] - 导出数据为JSON，势力筛选：比湿奴
[2025-03-24 16:41:46,835] [INFO] [data_service:export_data_to_json:557] - 导出 10 名玩家的数据
[2025-03-24 16:41:46,836] [INFO] [battle:export_json:181] - 数据导出成功，文件名: battle_data_比湿奴_20250324_164146.json
[2025-03-24 16:41:50,640] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:41:50,641] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:41:50,670] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 16:46:07,900] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 16:46:07,905] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 16:46:08,062] [INFO] [__init__:create_app:30] - 数据库扩展已初始化
[2025-03-24 16:46:08,251] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 16:46:08,279] [INFO] [__init__:create_app:38] - 蓝图已注册: /battle, /
[2025-03-24 16:46:08,281] [INFO] [__init__:create_app:43] - 检查数据库连接...
[2025-03-24 16:46:08,364] [INFO] [__init__:create_app:47] - 数据库连接正常
[2025-03-24 16:46:08,366] [INFO] [__init__:create_app:108] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 16:46:08,366] [INFO] [__init__:create_app:109] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 16:46:09,353] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:46:09,442] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:46:09,544] [ERROR] [home:index:82] - 生成首页仪表盘时出错: No filter named 'zip'.
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 75, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
                        overall_stats=overall_stats,
                        top_killers=top_killers,
                        top_scorers=top_scorers)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 100, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 261, in block 'scripts'
    data: {{ chart_data.factions | tojson | map('zip', chart_data.kills) | map('list') | list | tojson }}
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\async_utils.py", line 48, in wrapper
    return normal_func(*args, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1365, in sync_do_list
    return list(value)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1502, in sync_do_map
    for item in value:
                ^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1503, in sync_do_map
    yield func(item)
          ~~~~^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1745, in func
    return context.environment.call_filter(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name, item, args, kwargs, context=context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 569, in call_filter
    return self._filter_test_common(
           ~~~~~~~~~~~~~~~~~~~~~~~~^
        name, value, args, kwargs, context, eval_ctx, True
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 526, in _filter_test_common
    raise TemplateRuntimeError(msg)
jinja2.exceptions.TemplateRuntimeError: No filter named 'zip'.
[2025-03-24 16:46:09,568] [CRITICAL] [__init__:handle_exception:105] - 未处理的异常: No filter named 'zip'.
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 75, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
                        overall_stats=overall_stats,
                        top_killers=top_killers,
                        top_scorers=top_scorers)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 100, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 261, in block 'scripts'
    data: {{ chart_data.factions | tojson | map('zip', chart_data.kills) | map('list') | list | tojson }}
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\async_utils.py", line 48, in wrapper
    return normal_func(*args, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1365, in sync_do_list
    return list(value)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1502, in sync_do_map
    for item in value:
                ^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1503, in sync_do_map
    yield func(item)
          ~~~~^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1745, in func
    return context.environment.call_filter(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name, item, args, kwargs, context=context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 569, in call_filter
    return self._filter_test_common(
           ~~~~~~~~~~~~~~~~~~~~~~~~^
        name, value, args, kwargs, context, eval_ctx, True
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 526, in _filter_test_common
    raise TemplateRuntimeError(msg)
jinja2.exceptions.TemplateRuntimeError: No filter named 'zip'.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
    return render_template('home/index.html',
                        chart_data={'factions': [], 'kills': [], 'deaths': [], 'blessings': []},
    ...<2 lines>...
                        top_killers=[],
                        top_scorers=[])
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 100, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 261, in block 'scripts'
    data: {{ chart_data.factions | tojson | map('zip', chart_data.kills) | map('list') | list | tojson }}
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\async_utils.py", line 48, in wrapper
    return normal_func(*args, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1365, in sync_do_list
    return list(value)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1502, in sync_do_map
    for item in value:
                ^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1503, in sync_do_map
    yield func(item)
          ~~~~^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1745, in func
    return context.environment.call_filter(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name, item, args, kwargs, context=context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 569, in call_filter
    return self._filter_test_common(
           ~~~~~~~~~~~~~~~~~~~~~~~~^
        name, value, args, kwargs, context, eval_ctx, True
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 526, in _filter_test_common
    raise TemplateRuntimeError(msg)
jinja2.exceptions.TemplateRuntimeError: No filter named 'zip'.
[2025-03-24 16:46:19,259] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:46:19,347] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:46:19,353] [ERROR] [home:index:82] - 生成首页仪表盘时出错: No filter named 'zip'.
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 75, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
                        overall_stats=overall_stats,
                        top_killers=top_killers,
                        top_scorers=top_scorers)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 100, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 261, in block 'scripts'
    data: {{ chart_data.factions | tojson | map('zip', chart_data.kills) | map('list') | list | tojson }}
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\async_utils.py", line 48, in wrapper
    return normal_func(*args, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1365, in sync_do_list
    return list(value)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1502, in sync_do_map
    for item in value:
                ^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1503, in sync_do_map
    yield func(item)
          ~~~~^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1745, in func
    return context.environment.call_filter(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name, item, args, kwargs, context=context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 569, in call_filter
    return self._filter_test_common(
           ~~~~~~~~~~~~~~~~~~~~~~~~^
        name, value, args, kwargs, context, eval_ctx, True
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 526, in _filter_test_common
    raise TemplateRuntimeError(msg)
jinja2.exceptions.TemplateRuntimeError: No filter named 'zip'.
[2025-03-24 16:46:19,367] [CRITICAL] [__init__:handle_exception:105] - 未处理的异常: No filter named 'zip'.
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 75, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
                        overall_stats=overall_stats,
                        top_killers=top_killers,
                        top_scorers=top_scorers)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 100, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 261, in block 'scripts'
    data: {{ chart_data.factions | tojson | map('zip', chart_data.kills) | map('list') | list | tojson }}
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\async_utils.py", line 48, in wrapper
    return normal_func(*args, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1365, in sync_do_list
    return list(value)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1502, in sync_do_map
    for item in value:
                ^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1503, in sync_do_map
    yield func(item)
          ~~~~^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1745, in func
    return context.environment.call_filter(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name, item, args, kwargs, context=context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 569, in call_filter
    return self._filter_test_common(
           ~~~~~~~~~~~~~~~~~~~~~~~~^
        name, value, args, kwargs, context, eval_ctx, True
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 526, in _filter_test_common
    raise TemplateRuntimeError(msg)
jinja2.exceptions.TemplateRuntimeError: No filter named 'zip'.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
    return render_template('home/index.html',
                        chart_data={'factions': [], 'kills': [], 'deaths': [], 'blessings': []},
    ...<2 lines>...
                        top_killers=[],
                        top_scorers=[])
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 100, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 261, in block 'scripts'
    data: {{ chart_data.factions | tojson | map('zip', chart_data.kills) | map('list') | list | tojson }}
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\async_utils.py", line 48, in wrapper
    return normal_func(*args, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1365, in sync_do_list
    return list(value)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1502, in sync_do_map
    for item in value:
                ^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1503, in sync_do_map
    yield func(item)
          ~~~~^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1745, in func
    return context.environment.call_filter(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name, item, args, kwargs, context=context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 569, in call_filter
    return self._filter_test_common(
           ~~~~~~~~~~~~~~~~~~~~~~~~^
        name, value, args, kwargs, context, eval_ctx, True
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 526, in _filter_test_common
    raise TemplateRuntimeError(msg)
jinja2.exceptions.TemplateRuntimeError: No filter named 'zip'.
[2025-03-24 16:46:21,869] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:46:21,974] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:46:21,979] [ERROR] [home:index:82] - 生成首页仪表盘时出错: No filter named 'zip'.
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 75, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
                        overall_stats=overall_stats,
                        top_killers=top_killers,
                        top_scorers=top_scorers)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 100, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 261, in block 'scripts'
    data: {{ chart_data.factions | tojson | map('zip', chart_data.kills) | map('list') | list | tojson }}
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\async_utils.py", line 48, in wrapper
    return normal_func(*args, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1365, in sync_do_list
    return list(value)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1502, in sync_do_map
    for item in value:
                ^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1503, in sync_do_map
    yield func(item)
          ~~~~^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1745, in func
    return context.environment.call_filter(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name, item, args, kwargs, context=context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 569, in call_filter
    return self._filter_test_common(
           ~~~~~~~~~~~~~~~~~~~~~~~~^
        name, value, args, kwargs, context, eval_ctx, True
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 526, in _filter_test_common
    raise TemplateRuntimeError(msg)
jinja2.exceptions.TemplateRuntimeError: No filter named 'zip'.
[2025-03-24 16:46:21,993] [CRITICAL] [__init__:handle_exception:105] - 未处理的异常: No filter named 'zip'.
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 75, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
                        overall_stats=overall_stats,
                        top_killers=top_killers,
                        top_scorers=top_scorers)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 100, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 261, in block 'scripts'
    data: {{ chart_data.factions | tojson | map('zip', chart_data.kills) | map('list') | list | tojson }}
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\async_utils.py", line 48, in wrapper
    return normal_func(*args, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1365, in sync_do_list
    return list(value)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1502, in sync_do_map
    for item in value:
                ^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1503, in sync_do_map
    yield func(item)
          ~~~~^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1745, in func
    return context.environment.call_filter(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name, item, args, kwargs, context=context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 569, in call_filter
    return self._filter_test_common(
           ~~~~~~~~~~~~~~~~~~~~~~~~^
        name, value, args, kwargs, context, eval_ctx, True
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 526, in _filter_test_common
    raise TemplateRuntimeError(msg)
jinja2.exceptions.TemplateRuntimeError: No filter named 'zip'.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
    return render_template('home/index.html',
                        chart_data={'factions': [], 'kills': [], 'deaths': [], 'blessings': []},
    ...<2 lines>...
                        top_killers=[],
                        top_scorers=[])
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 100, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 261, in block 'scripts'
    data: {{ chart_data.factions | tojson | map('zip', chart_data.kills) | map('list') | list | tojson }}
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\async_utils.py", line 48, in wrapper
    return normal_func(*args, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1365, in sync_do_list
    return list(value)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1502, in sync_do_map
    for item in value:
                ^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1503, in sync_do_map
    yield func(item)
          ~~~~^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1745, in func
    return context.environment.call_filter(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name, item, args, kwargs, context=context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 569, in call_filter
    return self._filter_test_common(
           ~~~~~~~~~~~~~~~~~~~~~~~~^
        name, value, args, kwargs, context, eval_ctx, True
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 526, in _filter_test_common
    raise TemplateRuntimeError(msg)
jinja2.exceptions.TemplateRuntimeError: No filter named 'zip'.
[2025-03-24 16:49:54,813] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 16:49:54,818] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 16:49:54,959] [INFO] [__init__:create_app:35] - 数据库扩展已初始化
[2025-03-24 16:49:55,061] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 16:49:55,076] [INFO] [__init__:create_app:43] - 蓝图已注册: /battle, /
[2025-03-24 16:49:55,077] [INFO] [__init__:create_app:48] - 检查数据库连接...
[2025-03-24 16:49:55,096] [INFO] [__init__:create_app:52] - 数据库连接正常
[2025-03-24 16:49:55,096] [INFO] [__init__:create_app:113] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 16:49:55,096] [INFO] [__init__:create_app:114] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 16:49:55,167] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:49:55,263] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:50:43,473] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:50:43,475] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:50:43,505] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 16:50:48,562] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:50:48,562] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:50:48,566] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:50:48,568] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_165048.csv
[2025-03-24 16:50:48,568] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 16:50:48,569] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 16:50:48,818] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:50:48,907] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:50:50,455] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 16:50:52,216] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:50:52,305] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:51:20,808] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:51:20,893] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:51:23,458] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:51:23,459] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:51:23,488] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 16:53:55,971] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:53:55,971] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:53:56,000] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 16:54:04,255] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 16:54:04,260] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 16:54:04,397] [INFO] [__init__:create_app:35] - 数据库扩展已初始化
[2025-03-24 16:54:04,508] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 16:54:04,525] [INFO] [__init__:create_app:43] - 蓝图已注册: /battle, /
[2025-03-24 16:54:04,526] [INFO] [__init__:create_app:48] - 检查数据库连接...
[2025-03-24 16:54:04,554] [INFO] [__init__:create_app:52] - 数据库连接正常
[2025-03-24 16:54:04,555] [INFO] [__init__:create_app:113] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 16:54:04,556] [INFO] [__init__:create_app:114] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 16:54:07,091] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:54:07,092] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:54:07,126] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 16:54:08,684] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:54:08,686] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:54:08,719] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 16:54:11,474] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:54:11,571] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:54:18,430] [WARNING] [__init__:page_not_found:99] - 404 错误: /battle/player/灬}域V随风灬/kills, 来源: http://localhost:5000/
[2025-03-24 16:54:21,636] [WARNING] [__init__:page_not_found:99] - 404 错误: /battle/player/灬}域V随风灬/kills, 来源: http://localhost:5000/
[2025-03-24 16:56:18,505] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:56:18,594] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:56:23,053] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:56:23,054] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:56:23,083] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 16:56:25,602] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 16:56:25,603] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 16:56:25,607] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 16:56:25,608] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_165625.csv
[2025-03-24 16:56:25,608] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 16:56:25,609] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 16:56:25,860] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:56:25,944] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:56:27,193] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 16:56:29,416] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:56:29,512] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:56:30,749] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 16:56:30,829] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 16:59:04,449] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 16:59:04,450] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 16:59:04,479] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 17:00:15,867] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:00:15,872] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:00:16,087] [INFO] [__init__:create_app:35] - 数据库扩展已初始化
[2025-03-24 17:00:16,240] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:00:16,266] [INFO] [__init__:create_app:43] - 蓝图已注册: /battle, /
[2025-03-24 17:00:16,267] [INFO] [__init__:create_app:48] - 检查数据库连接...
[2025-03-24 17:00:16,290] [INFO] [__init__:create_app:52] - 数据库连接正常
[2025-03-24 17:00:16,291] [INFO] [__init__:create_app:113] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:00:16,291] [INFO] [__init__:create_app:114] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:00:16,497] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:00:16,497] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:00:16,528] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 17:00:16,752] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:00:16,753] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:00:16,781] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 17:00:18,790] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:00:18,870] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 17:02:35,379] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:02:35,490] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 17:02:41,396] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:02:41,397] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:02:41,431] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 17:02:44,940] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:02:44,940] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 17:02:44,952] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 17:02:50,251] [INFO] [data_service:get_battle_details_by_player:271] - 获取玩家ID 36 的战斗明细
[2025-03-24 17:02:50,284] [INFO] [data_service:get_battle_details_by_player:462] - 返回玩家 灬}域V随风灬 的战斗明细
[2025-03-24 17:02:55,524] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:02:55,628] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 17:06:01,363] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:06:01,452] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 17:06:14,687] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:06:14,770] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 17:07:42,397] [ERROR] [battle:get_player_kills:491] - 获取玩家 ぐ狂γ飙べ 击杀详情时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': 'ぐ狂γ飙べ'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 479, in get_player_kills
    result = db.session.execute(query, {'player_name': player_name})
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': 'ぐ狂γ飙べ'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:07:44,923] [ERROR] [battle:get_player_kills:491] - 获取玩家 灬}域V随风灬 击杀详情时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': '灬}域V随风灬'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 479, in get_player_kills
    result = db.session.execute(query, {'player_name': player_name})
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': '灬}域V随风灬'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:07:47,413] [ERROR] [battle:get_player_kills:491] - 获取玩家 灬}域V随风灬 击杀详情时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': '灬}域V随风灬'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 479, in get_player_kills
    result = db.session.execute(query, {'player_name': player_name})
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': '灬}域V随风灬'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:07:50,430] [ERROR] [battle:get_player_kills:491] - 获取玩家 ぐ狂γ飙べ 击杀详情时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': 'ぐ狂γ飙べ'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 479, in get_player_kills
    result = db.session.execute(query, {'player_name': player_name})
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': 'ぐ狂γ飙べ'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:08:41,936] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 17:08:41,937] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 17:08:41,939] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 17:08:41,941] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_170841.csv
[2025-03-24 17:08:41,942] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 17:08:41,943] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 17:08:42,199] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:08:42,277] [INFO] [data_service:get_faction_stats:165] - 返回 3 个势力的统计数据
[2025-03-24 17:08:44,679] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:08:44,680] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:08:44,709] [INFO] [data_service:get_player_rankings:261] - 返回 21 名玩家的排名数据
[2025-03-24 17:08:49,931] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:08:49,931] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 17:08:49,944] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 17:08:55,298] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:08:55,298] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 17:08:55,311] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 17:08:57,045] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:08:57,046] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：湿婆, 限制数量：30
[2025-03-24 17:08:57,057] [INFO] [data_service:get_player_rankings:261] - 返回 1 名玩家的排名数据
[2025-03-24 17:08:59,692] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:08:59,692] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 17:08:59,707] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 17:09:02,124] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:09:02,125] [INFO] [data_service:get_player_rankings:171] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 17:09:02,139] [INFO] [data_service:get_player_rankings:261] - 返回 10 名玩家的排名数据
[2025-03-24 17:09:38,772] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:09:38,781] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:09:39,009] [INFO] [__init__:create_app:35] - 数据库扩展已初始化
[2025-03-24 17:09:39,122] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:09:39,146] [INFO] [__init__:create_app:43] - 蓝图已注册: /battle, /
[2025-03-24 17:09:39,146] [INFO] [__init__:create_app:48] - 检查数据库连接...
[2025-03-24 17:09:39,159] [INFO] [__init__:create_app:52] - 数据库连接正常
[2025-03-24 17:09:39,160] [INFO] [__init__:create_app:113] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:09:39,160] [INFO] [__init__:create_app:114] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:09:39,415] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:09:39,503] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:10:56,981] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:10:56,982] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:10:57,011] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 17:11:07,775] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:11:07,776] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-24 17:11:07,791] [INFO] [data_service:get_player_rankings:305] - 返回 10 名玩家的排名数据
[2025-03-24 17:11:11,158] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:11:11,158] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 17:11:11,172] [INFO] [data_service:get_player_rankings:305] - 返回 10 名玩家的排名数据
[2025-03-24 17:17:16,189] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:17:16,284] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:17:20,239] [ERROR] [battle:get_player_kills:491] - 获取玩家 灬}域V随风灬 击杀详情时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': '灬}域V随风灬'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 479, in get_player_kills
    result = db.session.execute(query, {'player_name': player_name})
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': '灬}域V随风灬'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:17:23,717] [ERROR] [battle:get_player_kills:491] - 获取玩家 灬}域V随风灬 击杀详情时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': '灬}域V随风灬'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 479, in get_player_kills
    result = db.session.execute(query, {'player_name': player_name})
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p2.name as victim,
                p2.faction as victim_faction,
                COUNT(*) as count
            FROM battle_records br
            JOIN person p1 ON br.winner_id = p1.id
            JOIN person p2 ON br.loser_id = p2.id
            WHERE p1.name = %(player_name)s
            GROUP BY p2.name, p2.faction
            ORDER BY count DESC
        ]
[parameters: {'player_name': '灬}域V随风灬'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:17:27,049] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 17:17:27,051] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 17:17:27,056] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 17:17:27,058] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_171727.csv
[2025-03-24 17:17:27,059] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 17:17:27,060] [ERROR] [battle:report:276] - 生成报告时出错: battle/report.html
[2025-03-24 17:17:27,372] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:17:27,471] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:17:28,391] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:17:28,392] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:17:28,421] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 17:20:21,427] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:20:21,432] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:20:21,596] [INFO] [__init__:create_app:35] - 数据库扩展已初始化
[2025-03-24 17:20:21,714] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:20:21,738] [INFO] [__init__:create_app:43] - 蓝图已注册: /battle, /
[2025-03-24 17:20:21,739] [INFO] [__init__:create_app:48] - 检查数据库连接...
[2025-03-24 17:20:21,762] [INFO] [__init__:create_app:52] - 数据库连接正常
[2025-03-24 17:20:21,763] [INFO] [__init__:create_app:113] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:20:21,764] [INFO] [__init__:create_app:114] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:21:30,373] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:21:30,378] [INFO] [__init__:create_app:17] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:21:30,517] [INFO] [__init__:create_app:35] - 数据库扩展已初始化
[2025-03-24 17:21:30,631] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:21:30,651] [INFO] [__init__:create_app:43] - 蓝图已注册: /battle, /
[2025-03-24 17:21:30,651] [INFO] [__init__:create_app:48] - 检查数据库连接...
[2025-03-24 17:21:30,679] [INFO] [__init__:create_app:52] - 数据库连接正常
[2025-03-24 17:21:30,679] [INFO] [__init__:create_app:113] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:21:30,680] [INFO] [__init__:create_app:114] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:21:30,814] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:21:30,815] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:21:30,843] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 17:21:32,973] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:21:33,070] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:24:47,656] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:24:47,660] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:24:47,777] [INFO] [__init__:create_app:34] - 数据库扩展已初始化
[2025-03-24 17:24:47,853] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:24:47,968] [INFO] [__init__:create_app:44] - 蓝图已注册: /auth, /battle, /
[2025-03-24 17:24:47,969] [INFO] [__init__:create_app:54] - 检查数据库连接...
[2025-03-24 17:24:47,985] [INFO] [__init__:create_app:58] - 数据库连接正常
[2025-03-24 17:24:47,986] [INFO] [__init__:create_app:119] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:24:47,986] [INFO] [__init__:create_app:120] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:24:52,586] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:24:52,681] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:24:52,765] [ERROR] [home:index:83] - 生成首页仪表盘时出错: No filter named 'chart_data'.
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 75, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
    ...<2 lines>...
                        top_scorers=top_scorers,
                        top_deaths=top_deaths)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 146, in render_template
    template = app.jinja_env.get_or_select_template(template_name_or_list)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1087, in get_or_select_template
    return self.get_template(template_name_or_list, parent, globals)
           ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1016, in get_template
    return self._load_template(name, globals)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 975, in _load_template
    template = self.loader.load(self, name, self.make_globals(globals))
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\loaders.py", line 138, in load
    code = environment.compile(source, name, filename)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 771, in compile
    self.handle_exception(source=source_hint)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 338, in template
    data: {{ chart_data.factions | chart_data(chart_data.kills) | tojson }}
    ^^^^^^^^^
jinja2.exceptions.TemplateAssertionError: No filter named 'chart_data'.
[2025-03-24 17:24:52,817] [CRITICAL] [__init__:handle_exception:116] - 未处理的异常: No filter named 'chart_data'.
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 75, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
    ...<2 lines>...
                        top_scorers=top_scorers,
                        top_deaths=top_deaths)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 146, in render_template
    template = app.jinja_env.get_or_select_template(template_name_or_list)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1087, in get_or_select_template
    return self.get_template(template_name_or_list, parent, globals)
           ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1016, in get_template
    return self._load_template(name, globals)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 975, in _load_template
    template = self.loader.load(self, name, self.make_globals(globals))
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\loaders.py", line 138, in load
    code = environment.compile(source, name, filename)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 771, in compile
    self.handle_exception(source=source_hint)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 338, in template
    data: {{ chart_data.factions | chart_data(chart_data.kills) | tojson }}
    ^^^^^^^^^
jinja2.exceptions.TemplateAssertionError: No filter named 'chart_data'.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\routes\home.py", line 84, in index
    return render_template('home/index.html',
                        chart_data={'factions': [], 'kills': [], 'deaths': [], 'blessings': []},
    ...<3 lines>...
                        top_scorers=[],
                        top_deaths=[])
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 146, in render_template
    template = app.jinja_env.get_or_select_template(template_name_or_list)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1087, in get_or_select_template
    return self.get_template(template_name_or_list, parent, globals)
           ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1016, in get_template
    return self._load_template(name, globals)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 975, in _load_template
    template = self.loader.load(self, name, self.make_globals(globals))
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\loaders.py", line 138, in load
    code = environment.compile(source, name, filename)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 771, in compile
    self.handle_exception(source=source_hint)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 338, in template
    data: {{ chart_data.factions | chart_data(chart_data.kills) | tojson }}
    ^^^^^^^^^
jinja2.exceptions.TemplateAssertionError: No filter named 'chart_data'.
[2025-03-24 17:28:57,237] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:28:57,243] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:28:57,464] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 17:28:57,612] [INFO] [battle:<module>:27] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:28:57,705] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 17:28:57,706] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 17:28:57,721] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 17:28:57,722] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:28:57,722] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:29:00,228] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:29:00,335] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:29:03,955] [INFO] [battle:upload_file:38] - 访问文件上传页面
[2025-03-24 17:29:05,689] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:29:05,779] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:29:07,063] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:29:07,150] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:29:09,229] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:29:09,230] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:29:09,262] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 17:29:16,036] [INFO] [data_service:get_battle_details_by_player:315] - 获取玩家ID 36 的战斗明细
[2025-03-24 17:29:16,085] [INFO] [data_service:get_battle_details_by_player:506] - 返回玩家 灬}域V随风灬 的战斗明细
[2025-03-24 17:30:46,011] [INFO] [battle:rankings:119] - 访问玩家排名页面
[2025-03-24 17:30:46,011] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:30:46,041] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 17:30:58,333] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:30:58,419] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:31:04,710] [INFO] [data_service:get_faction_stats:12] - 获取势力统计数据
[2025-03-24 17:31:04,794] [INFO] [data_service:get_faction_stats:209] - 返回 3 个势力的统计数据
[2025-03-24 17:36:35,751] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:36:35,754] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:36:35,912] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 17:36:36,038] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:40:24,480] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:40:24,484] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:40:24,602] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 17:40:24,689] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:40:24,802] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 17:40:24,803] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 17:40:24,829] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 17:40:24,830] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:40:24,830] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:40:34,882] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 36, in get_faction_stats
    death_result = db.session.execute(death_query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:40:41,228] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 36, in get_faction_stats
    death_result = db.session.execute(death_query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:40:43,248] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 17:40:43,249] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:40:43,277] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 17:40:47,938] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 17:40:47,939] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 17:40:47,943] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 17:40:47,945] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_174047.csv
[2025-03-24 17:40:47,945] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 17:40:47,946] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-24 17:40:48,264] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 36, in get_faction_stats
    death_result = db.session.execute(death_query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:40:50,191] [INFO] [battle:upload_file:40] - 访问文件上传页面
[2025-03-24 17:40:52,464] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 36, in get_faction_stats
    death_result = db.session.execute(death_query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:41:02,677] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 36, in get_faction_stats
    death_result = db.session.execute(death_query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:43:06,662] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 36, in get_faction_stats
    death_result = db.session.execute(death_query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:45:50,983] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 36, in get_faction_stats
    death_result = db.session.execute(death_query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:45:52,595] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.battle_records' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 36, in get_faction_stats
    death_result = db.session.execute(death_query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.battle_records' doesn't exist")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_records br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:46:00,449] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:46:00,452] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:46:00,581] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 17:46:00,667] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:46:00,743] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 17:46:00,744] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 17:46:00,768] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 17:46:00,769] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:46:00,769] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:46:03,437] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'p.faction' in 'field list'")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_record br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'p.faction' in 'field list'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 36, in get_faction_stats
    death_result = db.session.execute(death_query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'p.faction' in 'field list'")
[SQL: 
            SELECT 
                p.name,
                p.faction,
                COUNT(*) as deaths
            FROM battle_record br
            JOIN person p ON br.loser_id = p.id
            GROUP BY p.name, p.faction
            ORDER BY deaths DESC
            LIMIT 3
        ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 17:52:08,928] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:52:08,932] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:52:09,095] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 17:52:09,186] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:52:09,271] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 17:52:09,272] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 17:52:09,289] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 17:52:09,290] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:52:09,290] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:52:14,559] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.blessings' doesn't exist")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                        ) as deaths,
                        (
                            SELECT COUNT(*) 
                            FROM blessings b 
                            WHERE b.player_id = p.id
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.blessings' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 119, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.blessings' doesn't exist")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                        ) as deaths,
                        (
                            SELECT COUNT(*) 
                            FROM blessings b 
                            WHERE b.player_id = p.id
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:52:17,360] [ERROR] [data_service:get_faction_stats:145] - 获取势力统计数据时出错: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.blessings' doesn't exist")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                        ) as deaths,
                        (
                            SELECT COUNT(*) 
                            FROM blessings b 
                            WHERE b.player_id = p.id
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.ProgrammingError: (1146, "Table 'oneapi.blessings' doesn't exist")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 119, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.ProgrammingError: (pymysql.err.ProgrammingError) (1146, "Table 'oneapi.blessings' doesn't exist")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                        ) as deaths,
                        (
                            SELECT COUNT(*) 
                            FROM blessings b 
                            WHERE b.player_id = p.id
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
[2025-03-24 17:56:28,055] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 17:56:28,060] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 17:56:28,259] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 17:56:28,355] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 17:56:28,436] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 17:56:28,436] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 17:56:28,454] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 17:56:28,455] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 17:56:28,455] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 17:56:28,835] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 17:57:02,472] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 17:57:02,473] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:57:02,507] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 17:57:45,424] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 17:57:48,323] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 17:57:48,324] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 17:57:48,355] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 17:57:49,718] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 17:57:49,718] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 17:57:49,721] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 17:57:49,723] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_175749.csv
[2025-03-24 17:57:49,724] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 17:57:49,724] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-24 17:57:50,155] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 17:57:51,971] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 17:57:51,972] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 17:57:51,976] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 17:57:51,977] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_175751.csv
[2025-03-24 17:57:51,978] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 17:57:51,978] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-24 17:57:52,477] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:01:26,144] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:01:29,272] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:01:31,275] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:01:32,792] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:01:34,173] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:01:36,054] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:01:37,498] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:02:25,734] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:02:28,942] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:02:33,626] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:09:46,754] [INFO] [data_service:get_faction_stats:141] - 返回 3 个势力的统计数据
[2025-03-24 18:12:37,095] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:12:37,099] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:12:37,276] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:12:37,401] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:12:37,506] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:12:37,507] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:12:37,527] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:12:37,528] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:12:37,529] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:12:37,831] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 18:12:37,978] [ERROR] [home:index:82] - 生成首页仪表盘时出错: 'overall_stats' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    return render_template('home/index.html',
                       chart_data=chart_data,
    ...<5 lines>...
                       top_deaths=top_deaths,
                       date_range=date_range)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 113, in block 'content'
    <div class="stat-value">{{ overall_stats.total_players }}</div>
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'overall_stats' is undefined
[2025-03-24 18:12:37,989] [CRITICAL] [__init__:handle_exception:120] - 未处理的异常: 'overall_stats' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    return render_template('home/index.html',
                       chart_data=chart_data,
    ...<5 lines>...
                       top_deaths=top_deaths,
                       date_range=date_range)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 113, in block 'content'
    <div class="stat-value">{{ overall_stats.total_players }}</div>
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'overall_stats' is undefined

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\auth.py", line 12, in decorated_function
    return f(*args, **kwargs)
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
    return render_template('home/index.html',
                       chart_data={'factions': [], 'kills': [], 'deaths': [], 'blessings': []},
    ...<5 lines>...
                       top_deaths=[],
                       date_range='all')
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 113, in block 'content'
    <div class="stat-value">{{ overall_stats.total_players }}</div>
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'overall_stats' is undefined
[2025-03-24 18:12:40,928] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:12:40,932] [ERROR] [home:index:82] - 生成首页仪表盘时出错: 'overall_stats' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    return render_template('home/index.html',
                       chart_data=chart_data,
    ...<5 lines>...
                       top_deaths=top_deaths,
                       date_range=date_range)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 113, in block 'content'
    <div class="stat-value">{{ overall_stats.total_players }}</div>
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'overall_stats' is undefined
[2025-03-24 18:12:40,939] [CRITICAL] [__init__:handle_exception:120] - 未处理的异常: 'overall_stats' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    return render_template('home/index.html',
                       chart_data=chart_data,
    ...<5 lines>...
                       top_deaths=top_deaths,
                       date_range=date_range)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 113, in block 'content'
    <div class="stat-value">{{ overall_stats.total_players }}</div>
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'overall_stats' is undefined

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\auth.py", line 12, in decorated_function
    return f(*args, **kwargs)
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
    return render_template('home/index.html',
                       chart_data={'factions': [], 'kills': [], 'deaths': [], 'blessings': []},
    ...<5 lines>...
                       top_deaths=[],
                       date_range='all')
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 113, in block 'content'
    <div class="stat-value">{{ overall_stats.total_players }}</div>
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'overall_stats' is undefined
[2025-03-24 18:14:52,363] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:14:52,370] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:14:52,516] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:14:52,607] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:14:52,692] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:14:52,693] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:14:52,729] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:14:52,730] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:14:52,731] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:14:57,133] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:57,368] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:57,626] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:57,868] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:58,128] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:58,367] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:58,631] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:58,859] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:59,142] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:59,347] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:59,643] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:14:59,840] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:00,142] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:00,334] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:00,833] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:01,078] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:01,347] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:01,565] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:01,835] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:02,056] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:03,299] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:03,953] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:04,197] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:04,456] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:04,680] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:04,939] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:05,169] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:05,424] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:05,602] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:06,116] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:06,373] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:06,638] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:06,874] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:07,146] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:10,266] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:10,767] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:11,012] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:11,266] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:11,508] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:11,793] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:12,007] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:12,288] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:12,512] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:12,784] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:12,996] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:13,290] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:13,479] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:13,789] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:13,976] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:14,482] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:14,732] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:14,976] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:15,230] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:15,474] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:16,737] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:17,253] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:17,492] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:17,768] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:18,019] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:18,272] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:18,521] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:18,773] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:19,046] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:19,292] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:19,548] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:19,846] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:20,048] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:20,579] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:20,819] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:21,096] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:21,323] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:21,589] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:21,825] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:22,098] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:27,319] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:27,823] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:28,071] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:28,333] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:28,579] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:28,843] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:29,080] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:29,348] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:29,653] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:29,889] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:30,383] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:30,651] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:30,905] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:31,408] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:31,667] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:31,916] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:32,179] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:32,418] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:32,684] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:15:32,923] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:03,152] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:03,665] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:03,904] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:04,162] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:04,403] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:04,659] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:04,907] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:05,155] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:05,404] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:05,649] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:05,910] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:06,151] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:06,415] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:06,647] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:06,908] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:07,152] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:07,398] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:07,642] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:07,900] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:16:08,146] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:21:32,785] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:21:32,794] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:21:33,065] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:21:33,214] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:21:33,321] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:21:33,322] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:21:33,343] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:21:33,344] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:21:33,344] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:21:33,729] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:21:33,884] [ERROR] [home:index:82] - 生成首页仪表盘时出错: 'overall_stats' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
    ...<5 lines>...
                        top_deaths=top_deaths,
                        date_range=date_range)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 113, in block 'content'
    <div class="stat-value">{{ overall_stats.total_players }}</div>
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'overall_stats' is undefined
[2025-03-24 18:21:33,922] [CRITICAL] [__init__:handle_exception:120] - 未处理的异常: 'overall_stats' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    return render_template('home/index.html',
                        chart_data=chart_data,
    ...<5 lines>...
                        top_deaths=top_deaths,
                        date_range=date_range)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 113, in block 'content'
    <div class="stat-value">{{ overall_stats.total_players }}</div>
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'overall_stats' is undefined

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\auth.py", line 12, in decorated_function
    return f(*args, **kwargs)
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
    return render_template('home/index.html',
                        chart_data={'factions': [], 'kills': [], 'deaths': [], 'blessings': []},
    ...<5 lines>...
                        top_deaths=[],
                        date_range='all')
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 113, in block 'content'
    <div class="stat-value">{{ overall_stats.total_players }}</div>
    ^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'overall_stats' is undefined
[2025-03-24 18:23:27,291] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:23:27,295] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:23:27,457] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:23:27,551] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:23:27,648] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:23:27,648] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:23:27,670] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:23:27,671] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:23:27,671] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:23:31,686] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:23:35,188] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 18:23:37,898] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 18:23:38,987] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 18:23:40,303] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 18:23:41,378] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-24 18:23:43,395] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:23:54,769] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:23:54,770] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:23:54,803] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:23:58,182] [INFO] [data_service:get_battle_details_by_player:315] - 获取玩家ID 1039 的战斗明细
[2025-03-24 18:23:58,212] [INFO] [data_service:get_battle_details_by_player:506] - 返回玩家 ぐ狂γ飙べ 的战斗明细
[2025-03-24 18:24:03,719] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:24:05,795] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:24:05,795] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:24:05,826] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:24:06,796] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:24:11,450] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-24 18:24:11,451] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-24 的战斗数据
[2025-03-24 18:24:11,454] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-24 的战斗数据
[2025-03-24 18:24:11,455] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250324_20250324_20250324_182411.csv
[2025-03-24 18:24:11,456] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-24 18:24:11,456] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-24 18:24:11,886] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:24:13,467] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:24:13,468] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:24:13,499] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:24:18,845] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:32:30,884] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:32:49,520] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:32:49,520] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:32:49,554] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:36:59,294] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:36:59,298] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:36:59,450] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:36:59,585] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:36:59,675] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:36:59,675] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:36:59,695] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:36:59,695] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:36:59,696] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:37:04,998] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:04,999] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:05,029] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:07,082] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:07,082] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:07,113] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:14,794] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:37:14,798] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:37:14,923] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:37:15,012] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:37:15,097] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:37:15,098] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:37:15,112] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:37:15,113] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:37:15,114] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:37:17,841] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:17,842] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:17,875] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:21,427] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:21,428] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:21,458] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:23,511] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:23,511] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:23,539] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:40,487] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:40,487] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:40,518] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:41,109] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:41,110] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:41,137] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:41,170] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:41,171] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:41,201] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:41,376] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:41,378] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:41,408] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:41,578] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:41,579] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:41,612] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:41,965] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:41,966] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:41,995] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:42,119] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:42,119] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:42,152] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:42,309] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:42,311] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:42,347] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:42,743] [WARNING] [__init__:page_not_found:109] - 404 错误: /favicon.ico, 来源: http://localhost:5000/battle/rankings
[2025-03-24 18:37:43,495] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:43,497] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:43,531] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:43,647] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:43,647] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:43,678] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:43,832] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:43,833] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:43,871] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:44,015] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:44,016] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:44,047] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:44,179] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:44,180] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:44,212] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:44,361] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:44,362] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:44,391] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:44,515] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:44,515] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:44,549] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:44,685] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:44,686] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:44,717] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:45,397] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:45,398] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:45,427] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:45,935] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:45,936] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:45,969] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:46,063] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:37:46,063] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:37:46,093] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:37:46,387] [WARNING] [__init__:page_not_found:109] - 404 错误: /favicon.ico, 来源: http://localhost:5000/battle/rankings
[2025-03-24 18:39:12,042] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:39:12,054] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:39:12,351] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:39:12,493] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:39:12,591] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:39:12,591] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:39:12,613] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:39:12,615] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:39:12,615] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:39:12,829] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:39:12,830] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:39:12,858] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:42:09,655] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:42:09,670] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:42:10,012] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:42:10,139] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:42:10,232] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:42:10,232] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:42:10,273] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:42:10,275] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:42:10,275] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:42:10,861] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:42:10,861] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:42:10,890] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:42:15,127] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:42:15,128] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:42:15,163] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:42:16,639] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:42:16,639] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:42:16,675] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:43:24,686] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:43:24,690] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:43:24,834] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:43:24,952] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:43:25,034] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:43:25,035] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:43:25,057] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:43:25,059] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:43:25,060] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:43:28,318] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:43:28,318] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:43:28,347] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:43:28,434] [ERROR] [battle:rankings:142] - 玩家排名页面渲染出错: 'float' object cannot be interpreted as an integer
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 137, in rankings
    return render_template('rankings.html',
                          players=player_rankings,
                          factions=factions,
                          current_faction=faction)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\rankings.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\rankings.html", line 75, in block 'content'
    <td>{% if player.blessings %}{% for i in range(player.blessings) %}&#x1F3EE;{% endfor %}{% else %}0{% endif %}</td>
    
TypeError: 'float' object cannot be interpreted as an integer
[2025-03-24 18:43:35,074] [INFO] [battle:upload_file:40] - 访问文件上传页面
[2025-03-24 18:43:44,177] [INFO] [battle:upload_file:40] - 访问文件上传页面
[2025-03-24 18:43:44,177] [INFO] [battle:upload_file:43] - 收到文件上传请求
[2025-03-24 18:43:44,182] [INFO] [battle:upload_file:58] - 收到上传文件: ChatLog_2025_3_22_0.txt
[2025-03-24 18:43:44,185] [INFO] [battle:upload_file:71] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 18:43:44,185] [INFO] [battle:upload_file:78] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 18:43:44,185] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_22_0.txt
[2025-03-24 18:43:44,186] [INFO] [file_parser:parse_text_file:62] - 文件大小: 71433 字节
[2025-03-24 18:43:44,188] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1035 行
[2025-03-24 18:43:44,188] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-24 18:43:44,188] [INFO] [file_parser:parse_battle_log:122] - 日志共 1034 行
[2025-03-24 18:43:44,196] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 582 条击杀记录和 8 条祝福记录
[2025-03-24 18:43:44,213] [INFO] [battle:upload_file:88] - 文件解析成功: 成功解析 582 条击杀记录和 8 条祝福记录
[2025-03-24 18:43:44,213] [INFO] [battle:upload_file:90] - 开始将解析结果保存到数据库
[2025-03-24 18:43:44,214] [INFO] [file_parser:save_battle_log_to_db:209] - 开始保存战斗日志到数据库: 582条击杀记录, 8条祝福记录
[2025-03-24 18:43:44,214] [INFO] [file_parser:save_battle_log_to_db:212] - 开始保存战斗日志到数据库
[2025-03-24 18:43:44,214] [INFO] [file_parser:save_battle_log_to_db:224] - 战斗日志中共涉及 41 名玩家
[2025-03-24 18:43:44,274] [INFO] [file_parser:save_battle_log_to_db:231] - 数据库中查询到 1036 名玩家记录
[2025-03-24 18:43:44,277] [INFO] [file_parser:save_battle_log_to_db:240] - 战斗日志中的玩家在数据库中找到 22/41 个，缺少 19 个
[2025-03-24 18:43:44,277] [WARNING] [file_parser:save_battle_log_to_db:244] - 大量玩家在数据库中不存在，缺少 19 个玩家记录
[2025-03-24 18:43:44,300] [INFO] [file_parser:save_battle_log_to_db:263] - 检查到 208 条已存在的战斗记录时间戳
[2025-03-24 18:43:44,300] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 18:43:44,301] [WARNING] [file_parser:save_battle_log_to_db:306] - 击杀者 沿途有你 在数据库中不存在
[2025-03-24 18:43:44,301] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 18:43:44,302] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 小傻帽 在数据库中不存在
[2025-03-24 18:43:44,302] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 沿途有你 在数据库中不存在
[2025-03-24 18:43:44,312] [INFO] [file_parser:save_battle_log_to_db:312] - 战斗记录处理完成：成功 0，错误 0，缺少玩家 368，跳过 214
[2025-03-24 18:43:44,317] [INFO] [file_parser:save_battle_log_to_db:328] - 检查到 4 条已存在的祝福记录时间戳
[2025-03-24 18:43:44,317] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 沿途有你 在数据库中不存在
[2025-03-24 18:43:44,319] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 18:43:44,319] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 18:43:44,320] [WARNING] [file_parser:save_battle_log_to_db:354] - 祝福接收者 123183 在数据库中不存在
[2025-03-24 18:43:44,331] [INFO] [file_parser:save_battle_log_to_db:386] - 祝福记录处理完成：成功 0，错误 0，缺少玩家 4
[2025-03-24 18:43:44,332] [INFO] [file_parser:save_battle_log_to_db:433] - 生成战绩报告SQL:
[2025-03-24 18:43:44,333] [INFO] [file_parser:save_battle_log_to_db:434] - 
            WITH player_stats AS (
                SELECT 
                    p.id,
                    p.name,
                    p.job,
                    p.god,
                    -- 统计击杀次数(通过win字段关联)
                    COUNT(DISTINCT CASE WHEN br.win = p.name THEN br.id END) as kills,
                    -- 统计死亡次数(通过lost字段关联)
                    COUNT(DISTINCT CASE WHEN br.lost = p.name THEN br.id END) as deaths,
                    -- 统计祝福次数(只有win的玩家才会有祝福)
                    SUM(CASE WHEN br.win = p.name THEN COALESCE(br.remark, 0) ELSE 0 END) as blessings,
                    -- 获取最后战斗位置和时间
                    MAX(br.position) as last_position,
                    MAX(br.publish_at) as last_battle_time
                FROM 
                    person p
                LEFT JOIN 
                    battle_record br ON br.win = p.name OR br.lost = p.name
                WHERE 1=1
                GROUP BY 
                    p.id, p.name, p.job, p.god
            )
            SELECT 
                id as player_id,
                name as player_name,
                job as player_job,
                god as player_god,
                kills,
                deaths,
                blessings,
                CASE WHEN deaths > 0 
                     THEN ROUND(CAST(kills AS FLOAT) / deaths, 2) 
                     ELSE kills END as kd_ratio,
                (kills * 3 + blessings - deaths) as score,
                last_position,
                last_battle_time
            FROM 
                player_stats
            ORDER BY 
                score DESC, kills DESC, deaths ASC;
            
[2025-03-24 18:43:44,336] [INFO] [file_parser:save_battle_log_to_db:440] - 战斗日志保存完成，总处理时间: 0.12 秒
[2025-03-24 18:43:44,341] [INFO] [battle:upload_file:94] - 数据保存成功: 处理完成：0 条战斗记录，0 条祝福记录
[2025-03-24 18:43:44,439] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:43:44,441] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:43:44,473] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:43:44,482] [ERROR] [battle:rankings:142] - 玩家排名页面渲染出错: 'float' object cannot be interpreted as an integer
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 137, in rankings
    return render_template('rankings.html',
                          players=player_rankings,
                          factions=factions,
                          current_faction=faction)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\rankings.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\rankings.html", line 75, in block 'content'
    <td>{% if player.blessings %}{% for i in range(player.blessings) %}&#x1F3EE;{% endfor %}{% else %}0{% endif %}</td>
    
TypeError: 'float' object cannot be interpreted as an integer
[2025-03-24 18:46:05,791] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:46:05,795] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:46:05,913] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:46:06,004] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:46:06,133] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:46:06,134] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:46:06,166] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:46:06,168] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:46:06,168] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:46:52,151] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:46:52,154] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:46:52,268] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:46:52,340] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:46:52,400] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:46:52,401] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:46:52,414] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:46:52,415] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:46:52,415] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:46:56,724] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:46:56,725] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:46:56,754] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:46:56,814] [ERROR] [battle:rankings:142] - 玩家排名页面渲染出错: 'float' object cannot be interpreted as an integer
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 137, in rankings
    return render_template('rankings.html',
                          players=player_rankings,
                          factions=factions,
                          current_faction=faction)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\rankings.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\rankings.html", line 75, in block 'content'
    <td>{% if player.blessings %}{% for i in range(player.blessings) %}&#x1F3EE;{% endfor %}{% else %}0{% endif %}</td>
    
TypeError: 'float' object cannot be interpreted as an integer
[2025-03-24 18:48:39,877] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-24 18:48:39,884] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-24 18:48:40,064] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-24 18:48:40,188] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-24 18:48:40,291] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-24 18:48:40,292] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-24 18:48:40,307] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-24 18:48:40,309] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-24 18:48:40,309] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-24 18:48:40,381] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:48:40,381] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:48:40,410] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
[2025-03-24 18:48:46,078] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:48:46,079] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-24 18:48:46,092] [INFO] [data_service:get_player_rankings:305] - 返回 10 名玩家的排名数据
[2025-03-24 18:49:11,521] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-24 18:49:17,662] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-24 18:49:17,663] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-24 18:49:17,691] [INFO] [data_service:get_player_rankings:305] - 返回 21 名玩家的排名数据
