[2025-03-25 09:43:36,639] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:43:36,644] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:43:36,854] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:43:36,981] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:43:37,062] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:43:37,062] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:43:37,075] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:43:37,076] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:43:37,076] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:43:41,722] [INFO] [battle:upload_file:40] - 访问文件上传页面
[2025-03-25 09:43:52,896] [INFO] [battle:upload_file:40] - 访问文件上传页面
[2025-03-25 09:43:52,896] [INFO] [battle:upload_file:43] - 收到文件上传请求
[2025-03-25 09:43:52,901] [INFO] [battle:upload_file:58] - 收到上传文件: ChatLog_2025_3_20_0.txt
[2025-03-25 09:43:52,909] [INFO] [battle:upload_file:71] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_20_0.txt
[2025-03-25 09:43:52,910] [INFO] [battle:upload_file:78] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_20_0.txt
[2025-03-25 09:43:52,910] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_20_0.txt
[2025-03-25 09:43:52,911] [INFO] [file_parser:parse_text_file:62] - 文件大小: 67884 字节
[2025-03-25 09:43:52,913] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1031 行
[2025-03-25 09:43:52,913] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-25 09:43:52,913] [INFO] [file_parser:parse_battle_log:122] - 日志共 1030 行
[2025-03-25 09:43:52,920] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 414 条击杀记录和 2 条祝福记录
[2025-03-25 09:43:52,942] [INFO] [battle:upload_file:88] - 文件解析成功: 成功解析 414 条击杀记录和 2 条祝福记录
[2025-03-25 09:43:52,943] [INFO] [battle:upload_file:90] - 开始将解析结果保存到数据库
[2025-03-25 09:43:52,944] [INFO] [file_parser:save_battle_log_to_db:209] - 开始保存战斗日志到数据库: 414条击杀记录, 2条祝福记录
[2025-03-25 09:43:52,945] [INFO] [file_parser:save_battle_log_to_db:212] - 开始保存战斗日志到数据库
[2025-03-25 09:43:52,945] [INFO] [file_parser:save_battle_log_to_db:224] - 战斗日志中共涉及 51 名玩家
[2025-03-25 09:43:53,013] [INFO] [file_parser:save_battle_log_to_db:231] - 数据库中查询到 1036 名玩家记录
[2025-03-25 09:43:53,016] [INFO] [file_parser:save_battle_log_to_db:240] - 战斗日志中的玩家在数据库中找到 49/51 个，缺少 2 个
[2025-03-25 09:43:53,016] [WARNING] [file_parser:save_battle_log_to_db:242] - 以下玩家在数据库中不存在: 沿途有你, 薇う风
[2025-03-25 09:43:53,027] [INFO] [file_parser:save_battle_log_to_db:263] - 检查到 0 条已存在的战斗记录时间戳
[2025-03-25 09:43:53,028] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 薇う风 在数据库中不存在
[2025-03-25 09:43:53,029] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 薇う风 在数据库中不存在
[2025-03-25 09:43:53,030] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 薇う风 在数据库中不存在
[2025-03-25 09:43:53,031] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 薇う风 在数据库中不存在
[2025-03-25 09:43:53,032] [WARNING] [file_parser:save_battle_log_to_db:306] - 击杀者 薇う风 在数据库中不存在
[2025-03-25 09:43:53,339] [INFO] [file_parser:save_battle_log_to_db:312] - 战斗记录处理完成：成功 351，错误 0，缺少玩家 63，跳过 0
[2025-03-25 09:43:53,343] [INFO] [file_parser:save_battle_log_to_db:328] - 检查到 0 条已存在的祝福记录时间戳
[2025-03-25 09:43:53,364] [INFO] [file_parser:save_battle_log_to_db:386] - 祝福记录处理完成：成功 2，错误 0，缺少玩家 0
[2025-03-25 09:43:53,365] [INFO] [file_parser:save_battle_log_to_db:433] - 生成战绩报告SQL:
[2025-03-25 09:43:53,365] [INFO] [file_parser:save_battle_log_to_db:434] - 
            WITH player_stats AS (
                SELECT 
                    p.id,
                    p.name,
                    p.job,
                    p.god,
                    -- 统计击杀次数(通过win字段关联)
                    COUNT(DISTINCT CASE WHEN br.win = p.name THEN br.id END) as kills,
                    -- 统计死亡次数(通过lost字段关联)
                    COUNT(DISTINCT CASE WHEN br.lost = p.name THEN br.id END) as deaths,
                    -- 统计祝福次数(只有win的玩家才会有祝福)
                    SUM(CASE WHEN br.win = p.name THEN COALESCE(br.remark, 0) ELSE 0 END) as blessings,
                    -- 获取最后战斗位置和时间
                    MAX(br.position) as last_position,
                    MAX(br.publish_at) as last_battle_time
                FROM 
                    person p
                LEFT JOIN 
                    battle_record br ON br.win = p.name OR br.lost = p.name
                WHERE 1=1
                GROUP BY 
                    p.id, p.name, p.job, p.god
            )
            SELECT 
                id as player_id,
                name as player_name,
                job as player_job,
                god as player_god,
                kills,
                deaths,
                blessings,
                CASE WHEN deaths > 0 
                     THEN ROUND(CAST(kills AS FLOAT) / deaths, 2) 
                     ELSE kills END as kd_ratio,
                (kills * 3 + blessings - deaths) as score,
                last_position,
                last_battle_time
            FROM 
                player_stats
            ORDER BY 
                score DESC, kills DESC, deaths ASC;
            
[2025-03-25 09:43:53,368] [INFO] [file_parser:save_battle_log_to_db:440] - 战斗日志保存完成，总处理时间: 0.42 秒
[2025-03-25 09:43:53,371] [INFO] [battle:upload_file:94] - 数据保存成功: 处理完成：351 条战斗记录，2 条祝福记录
[2025-03-25 09:43:53,687] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:43:53,687] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:43:53,730] [INFO] [data_service:get_player_rankings:314] - 返回 30 名玩家的排名数据，总击杀：342，总死亡：178，总祝福：2.0，总得分：850.0
[2025-03-25 09:43:53,807] [ERROR] [battle:rankings:142] - 玩家排名页面渲染出错: 'list object' has no attribute 'id'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 137, in rankings
    return render_template('rankings.html',
                          players=player_rankings,
                          factions=factions,
                          current_faction=faction)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\rankings.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\rankings.html", line 128, in block 'content'
    <td><a href="{{ url_for('battle.player_details', person_id=player.id) }}">{{ player.name|default('未知', true) }}</a></td>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 915, in build
    rv = self._partial_build(endpoint, values, method, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 794, in _partial_build
    rv = self._partial_build(
        endpoint, values, self.default_method, append_unknown
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 807, in _partial_build
    build_rv = rule.build(values, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\rules.py", line 826, in build
    return self._build_unknown(**values)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "<werkzeug routing>", line 1, in <builder:'/battle/player/<int:person_id>'>
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\converters.py", line 156, in to_url
    value = str(self.num_convert(value))
                ~~~~~~~~~~~~~~~~^^^^^^^
jinja2.exceptions.UndefinedError: 'list object' has no attribute 'id'
[2025-03-25 09:43:58,264] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:43:58,266] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:43:58,309] [INFO] [data_service:get_player_rankings:314] - 返回 30 名玩家的排名数据，总击杀：342，总死亡：178，总祝福：2.0，总得分：850.0
[2025-03-25 09:43:58,314] [ERROR] [battle:rankings:142] - 玩家排名页面渲染出错: 'list object' has no attribute 'id'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 137, in rankings
    return render_template('rankings.html',
                          players=player_rankings,
                          factions=factions,
                          current_faction=faction)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\rankings.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\rankings.html", line 128, in block 'content'
    <td><a href="{{ url_for('battle.player_details', person_id=player.id) }}">{{ player.name|default('未知', true) }}</a></td>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 915, in build
    rv = self._partial_build(endpoint, values, method, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 794, in _partial_build
    rv = self._partial_build(
        endpoint, values, self.default_method, append_unknown
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 807, in _partial_build
    build_rv = rule.build(values, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\rules.py", line 826, in build
    return self._build_unknown(**values)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "<werkzeug routing>", line 1, in <builder:'/battle/player/<int:person_id>'>
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\converters.py", line 156, in to_url
    value = str(self.num_convert(value))
                ~~~~~~~~~~~~~~~~^^^^^^^
jinja2.exceptions.UndefinedError: 'list object' has no attribute 'id'
[2025-03-25 09:43:59,911] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:43:59,912] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:43:59,957] [INFO] [data_service:get_player_rankings:314] - 返回 30 名玩家的排名数据，总击杀：342，总死亡：178，总祝福：2.0，总得分：850.0
[2025-03-25 09:43:59,965] [ERROR] [battle:rankings:142] - 玩家排名页面渲染出错: 'list object' has no attribute 'id'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 137, in rankings
    return render_template('rankings.html',
                          players=player_rankings,
                          factions=factions,
                          current_faction=faction)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\rankings.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\rankings.html", line 128, in block 'content'
    <td><a href="{{ url_for('battle.player_details', person_id=player.id) }}">{{ player.name|default('未知', true) }}</a></td>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 915, in build
    rv = self._partial_build(endpoint, values, method, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 794, in _partial_build
    rv = self._partial_build(
        endpoint, values, self.default_method, append_unknown
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 807, in _partial_build
    build_rv = rule.build(values, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\rules.py", line 826, in build
    return self._build_unknown(**values)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "<werkzeug routing>", line 1, in <builder:'/battle/player/<int:person_id>'>
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\converters.py", line 156, in to_url
    value = str(self.num_convert(value))
                ~~~~~~~~~~~~~~~~^^^^^^^
jinja2.exceptions.UndefinedError: 'list object' has no attribute 'id'
[2025-03-25 09:44:01,160] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:44:01,161] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:44:01,208] [INFO] [data_service:get_player_rankings:314] - 返回 30 名玩家的排名数据，总击杀：342，总死亡：178，总祝福：2.0，总得分：850.0
[2025-03-25 09:44:01,215] [ERROR] [battle:rankings:142] - 玩家排名页面渲染出错: 'list object' has no attribute 'id'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 137, in rankings
    return render_template('rankings.html',
                          players=player_rankings,
                          factions=factions,
                          current_faction=faction)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\rankings.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\rankings.html", line 128, in block 'content'
    <td><a href="{{ url_for('battle.player_details', person_id=player.id) }}">{{ player.name|default('未知', true) }}</a></td>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 915, in build
    rv = self._partial_build(endpoint, values, method, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 794, in _partial_build
    rv = self._partial_build(
        endpoint, values, self.default_method, append_unknown
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 807, in _partial_build
    build_rv = rule.build(values, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\rules.py", line 826, in build
    return self._build_unknown(**values)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "<werkzeug routing>", line 1, in <builder:'/battle/player/<int:person_id>'>
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\converters.py", line 156, in to_url
    value = str(self.num_convert(value))
                ~~~~~~~~~~~~~~~~^^^^^^^
jinja2.exceptions.UndefinedError: 'list object' has no attribute 'id'
[2025-03-25 09:44:02,230] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:44:02,231] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:44:02,274] [INFO] [data_service:get_player_rankings:314] - 返回 30 名玩家的排名数据，总击杀：342，总死亡：178，总祝福：2.0，总得分：850.0
[2025-03-25 09:44:02,281] [ERROR] [battle:rankings:142] - 玩家排名页面渲染出错: 'list object' has no attribute 'id'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 137, in rankings
    return render_template('rankings.html',
                          players=player_rankings,
                          factions=factions,
                          current_faction=faction)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\rankings.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\rankings.html", line 128, in block 'content'
    <td><a href="{{ url_for('battle.player_details', person_id=player.id) }}">{{ player.name|default('未知', true) }}</a></td>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 915, in build
    rv = self._partial_build(endpoint, values, method, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 794, in _partial_build
    rv = self._partial_build(
        endpoint, values, self.default_method, append_unknown
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 807, in _partial_build
    build_rv = rule.build(values, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\rules.py", line 826, in build
    return self._build_unknown(**values)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "<werkzeug routing>", line 1, in <builder:'/battle/player/<int:person_id>'>
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\converters.py", line 156, in to_url
    value = str(self.num_convert(value))
                ~~~~~~~~~~~~~~~~^^^^^^^
jinja2.exceptions.UndefinedError: 'list object' has no attribute 'id'
[2025-03-25 09:44:03,691] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:44:03,692] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:44:03,734] [INFO] [data_service:get_player_rankings:314] - 返回 30 名玩家的排名数据，总击杀：342，总死亡：178，总祝福：2.0，总得分：850.0
[2025-03-25 09:44:03,740] [ERROR] [battle:rankings:142] - 玩家排名页面渲染出错: 'list object' has no attribute 'id'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 137, in rankings
    return render_template('rankings.html',
                          players=player_rankings,
                          factions=factions,
                          current_faction=faction)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\rankings.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\rankings.html", line 128, in block 'content'
    <td><a href="{{ url_for('battle.player_details', person_id=player.id) }}">{{ player.name|default('未知', true) }}</a></td>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 2023, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
        endpoint,
    ...<3 lines>...
        force_external=_external,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 915, in build
    rv = self._partial_build(endpoint, values, method, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 794, in _partial_build
    rv = self._partial_build(
        endpoint, values, self.default_method, append_unknown
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\map.py", line 807, in _partial_build
    build_rv = rule.build(values, append_unknown)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\rules.py", line 826, in build
    return self._build_unknown(**values)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "<werkzeug routing>", line 1, in <builder:'/battle/player/<int:person_id>'>
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\werkzeug\routing\converters.py", line 156, in to_url
    value = str(self.num_convert(value))
                ~~~~~~~~~~~~~~~~^^^^^^^
jinja2.exceptions.UndefinedError: 'list object' has no attribute 'id'
[2025-03-25 09:46:01,988] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:46:01,993] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:46:02,243] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:46:02,406] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:46:02,526] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:46:02,527] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:46:02,562] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:46:02,564] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:46:02,564] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:46:02,684] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:46:02,685] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:46:02,730] [INFO] [data_service:get_player_rankings:314] - 返回 30 名玩家的排名数据，总击杀：342，总死亡：178，总祝福：2.0，总得分：850.0
[2025-03-25 09:46:10,955] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:46:10,956] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 09:46:10,975] [INFO] [data_service:get_player_rankings:314] - 返回 19 名玩家的排名数据，总击杀：216，总死亡：135，总祝福：1.0，总得分：514.0
[2025-03-25 09:49:16,391] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:49:16,395] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:49:16,571] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:49:16,804] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:49:16,903] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:49:16,904] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:49:16,922] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:49:16,924] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:49:16,924] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:49:20,942] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:49:20,943] [INFO] [data_service:get_player_rankings:222] - 获取玩家排名数据
[2025-03-25 09:49:20,947] [ERROR] [battle:rankings:144] - 玩家排名页面渲染出错: (pymysql.err.OperationalError) (1054, "Unknown column 'p.faction' in 'field list'")
[SQL: 
    WITH player_stats AS (
        SELECT 
            p.id AS player_id,
            p.name AS player_name,
            p.faction AS player_faction,
            COUNT(br.id) AS battles,
            SUM(CASE WHEN br.winner_id = p.id THEN 1 ELSE 0 END) AS kills,
            SUM(CASE WHEN br.loser_id = p.id THEN 1 ELSE 0 END) AS deaths
        FROM person p
        LEFT JOIN battle_record br ON p.id IN (br.winner_id, br.loser_id)
        WHERE (%(faction)s IS NULL OR p.faction = %(faction)s)
        AND (%(start_date)s IS NULL OR br.created_at >= %(start_date)s)
        AND (%(end_date)s IS NULL OR br.created_at <= %(end_date)s)
        GROUP BY p.id
    )
    SELECT 
        player_id, 
        player_name, 
        player_faction, 
        battles, 
        kills, 
        deaths,
        (kills * 3 - deaths) AS score
    FROM player_stats
    ORDER BY score DESC, kills DESC, deaths ASC
    LIMIT %(limit)s
    ]
[parameters: {'faction': '梵天', 'start_date': None, 'end_date': None, 'limit': 100}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'p.faction' in 'field list'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 130, in rankings
    player_rankings, total_count, total_score = get_player_rankings(faction=faction)
                                                ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\data_service.py", line 255, in get_player_rankings
    result = db.session.execute(query, {
        'faction': faction,
    ...<2 lines>...
        'limit': limit
    })
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'p.faction' in 'field list'")
[SQL: 
    WITH player_stats AS (
        SELECT 
            p.id AS player_id,
            p.name AS player_name,
            p.faction AS player_faction,
            COUNT(br.id) AS battles,
            SUM(CASE WHEN br.winner_id = p.id THEN 1 ELSE 0 END) AS kills,
            SUM(CASE WHEN br.loser_id = p.id THEN 1 ELSE 0 END) AS deaths
        FROM person p
        LEFT JOIN battle_record br ON p.id IN (br.winner_id, br.loser_id)
        WHERE (%(faction)s IS NULL OR p.faction = %(faction)s)
        AND (%(start_date)s IS NULL OR br.created_at >= %(start_date)s)
        AND (%(end_date)s IS NULL OR br.created_at <= %(end_date)s)
        GROUP BY p.id
    )
    SELECT 
        player_id, 
        player_name, 
        player_faction, 
        battles, 
        kills, 
        deaths,
        (kills * 3 - deaths) AS score
    FROM player_stats
    ORDER BY score DESC, kills DESC, deaths ASC
    LIMIT %(limit)s
    ]
[parameters: {'faction': '梵天', 'start_date': None, 'end_date': None, 'limit': 100}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 09:49:25,896] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:49:25,898] [INFO] [data_service:get_player_rankings:222] - 获取玩家排名数据
[2025-03-25 09:49:25,900] [ERROR] [battle:rankings:144] - 玩家排名页面渲染出错: (pymysql.err.OperationalError) (1054, "Unknown column 'p.faction' in 'field list'")
[SQL: 
    WITH player_stats AS (
        SELECT 
            p.id AS player_id,
            p.name AS player_name,
            p.faction AS player_faction,
            COUNT(br.id) AS battles,
            SUM(CASE WHEN br.winner_id = p.id THEN 1 ELSE 0 END) AS kills,
            SUM(CASE WHEN br.loser_id = p.id THEN 1 ELSE 0 END) AS deaths
        FROM person p
        LEFT JOIN battle_record br ON p.id IN (br.winner_id, br.loser_id)
        WHERE (%(faction)s IS NULL OR p.faction = %(faction)s)
        AND (%(start_date)s IS NULL OR br.created_at >= %(start_date)s)
        AND (%(end_date)s IS NULL OR br.created_at <= %(end_date)s)
        GROUP BY p.id
    )
    SELECT 
        player_id, 
        player_name, 
        player_faction, 
        battles, 
        kills, 
        deaths,
        (kills * 3 - deaths) AS score
    FROM player_stats
    ORDER BY score DESC, kills DESC, deaths ASC
    LIMIT %(limit)s
    ]
[parameters: {'faction': None, 'start_date': None, 'end_date': None, 'limit': 100}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'p.faction' in 'field list'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 130, in rankings
    player_rankings, total_count, total_score = get_player_rankings(faction=faction)
                                                ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\data_service.py", line 255, in get_player_rankings
    result = db.session.execute(query, {
        'faction': faction,
    ...<2 lines>...
        'limit': limit
    })
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'p.faction' in 'field list'")
[SQL: 
    WITH player_stats AS (
        SELECT 
            p.id AS player_id,
            p.name AS player_name,
            p.faction AS player_faction,
            COUNT(br.id) AS battles,
            SUM(CASE WHEN br.winner_id = p.id THEN 1 ELSE 0 END) AS kills,
            SUM(CASE WHEN br.loser_id = p.id THEN 1 ELSE 0 END) AS deaths
        FROM person p
        LEFT JOIN battle_record br ON p.id IN (br.winner_id, br.loser_id)
        WHERE (%(faction)s IS NULL OR p.faction = %(faction)s)
        AND (%(start_date)s IS NULL OR br.created_at >= %(start_date)s)
        AND (%(end_date)s IS NULL OR br.created_at <= %(end_date)s)
        GROUP BY p.id
    )
    SELECT 
        player_id, 
        player_name, 
        player_faction, 
        battles, 
        kills, 
        deaths,
        (kills * 3 - deaths) AS score
    FROM player_stats
    ORDER BY score DESC, kills DESC, deaths ASC
    LIMIT %(limit)s
    ]
[parameters: {'faction': None, 'start_date': None, 'end_date': None, 'limit': 100}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 09:51:20,920] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:51:20,925] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:51:21,147] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:51:21,249] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:51:21,354] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:51:21,355] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:51:21,386] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:51:21,388] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:51:21,388] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:51:21,521] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:51:21,521] [INFO] [data_service:get_player_rankings:222] - 获取玩家排名数据
[2025-03-25 09:51:21,525] [ERROR] [battle:rankings:144] - 玩家排名页面渲染出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.winner_id' in 'field list'")
[SQL: 
    WITH player_stats AS (
        SELECT 
            p.id AS player_id,
            p.name AS player_name,
            p.god AS player_faction,
            COUNT(br.id) AS battles,
            SUM(CASE WHEN br.winner_id = p.id THEN 1 ELSE 0 END) AS kills,
            SUM(CASE WHEN br.loser_id = p.id THEN 1 ELSE 0 END) AS deaths
        FROM person p
        LEFT JOIN battle_record br ON p.id IN (br.winner_id, br.loser_id)
        WHERE (%(faction)s IS NULL OR p.god = %(faction)s)
        AND (%(start_date)s IS NULL OR br.created_at >= %(start_date)s)
        AND (%(end_date)s IS NULL OR br.created_at <= %(end_date)s)
        GROUP BY p.id
    )
    SELECT 
        player_id, 
        player_name, 
        player_faction, 
        battles, 
        kills, 
        deaths,
        (kills * 3 - deaths) AS score
    FROM player_stats
    ORDER BY score DESC, kills DESC, deaths ASC
    LIMIT %(limit)s
    ]
[parameters: {'faction': None, 'start_date': None, 'end_date': None, 'limit': 100}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.winner_id' in 'field list'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 130, in rankings
    player_rankings, total_count, total_score = get_player_rankings(faction=faction)
                                                ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\data_service.py", line 255, in get_player_rankings
    result = db.session.execute(query, {
        'faction': faction,
    ...<2 lines>...
        'limit': limit
    })
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.winner_id' in 'field list'")
[SQL: 
    WITH player_stats AS (
        SELECT 
            p.id AS player_id,
            p.name AS player_name,
            p.god AS player_faction,
            COUNT(br.id) AS battles,
            SUM(CASE WHEN br.winner_id = p.id THEN 1 ELSE 0 END) AS kills,
            SUM(CASE WHEN br.loser_id = p.id THEN 1 ELSE 0 END) AS deaths
        FROM person p
        LEFT JOIN battle_record br ON p.id IN (br.winner_id, br.loser_id)
        WHERE (%(faction)s IS NULL OR p.god = %(faction)s)
        AND (%(start_date)s IS NULL OR br.created_at >= %(start_date)s)
        AND (%(end_date)s IS NULL OR br.created_at <= %(end_date)s)
        GROUP BY p.id
    )
    SELECT 
        player_id, 
        player_name, 
        player_faction, 
        battles, 
        kills, 
        deaths,
        (kills * 3 - deaths) AS score
    FROM player_stats
    ORDER BY score DESC, kills DESC, deaths ASC
    LIMIT %(limit)s
    ]
[parameters: {'faction': None, 'start_date': None, 'end_date': None, 'limit': 100}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 09:51:24,948] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:51:24,948] [INFO] [data_service:get_player_rankings:222] - 获取玩家排名数据
[2025-03-25 09:51:24,951] [ERROR] [battle:rankings:144] - 玩家排名页面渲染出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.winner_id' in 'field list'")
[SQL: 
    WITH player_stats AS (
        SELECT 
            p.id AS player_id,
            p.name AS player_name,
            p.god AS player_faction,
            COUNT(br.id) AS battles,
            SUM(CASE WHEN br.winner_id = p.id THEN 1 ELSE 0 END) AS kills,
            SUM(CASE WHEN br.loser_id = p.id THEN 1 ELSE 0 END) AS deaths
        FROM person p
        LEFT JOIN battle_record br ON p.id IN (br.winner_id, br.loser_id)
        WHERE (%(faction)s IS NULL OR p.god = %(faction)s)
        AND (%(start_date)s IS NULL OR br.created_at >= %(start_date)s)
        AND (%(end_date)s IS NULL OR br.created_at <= %(end_date)s)
        GROUP BY p.id
    )
    SELECT 
        player_id, 
        player_name, 
        player_faction, 
        battles, 
        kills, 
        deaths,
        (kills * 3 - deaths) AS score
    FROM player_stats
    ORDER BY score DESC, kills DESC, deaths ASC
    LIMIT %(limit)s
    ]
[parameters: {'faction': None, 'start_date': None, 'end_date': None, 'limit': 100}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.winner_id' in 'field list'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 130, in rankings
    player_rankings, total_count, total_score = get_player_rankings(faction=faction)
                                                ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\data_service.py", line 255, in get_player_rankings
    result = db.session.execute(query, {
        'faction': faction,
    ...<2 lines>...
        'limit': limit
    })
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.winner_id' in 'field list'")
[SQL: 
    WITH player_stats AS (
        SELECT 
            p.id AS player_id,
            p.name AS player_name,
            p.god AS player_faction,
            COUNT(br.id) AS battles,
            SUM(CASE WHEN br.winner_id = p.id THEN 1 ELSE 0 END) AS kills,
            SUM(CASE WHEN br.loser_id = p.id THEN 1 ELSE 0 END) AS deaths
        FROM person p
        LEFT JOIN battle_record br ON p.id IN (br.winner_id, br.loser_id)
        WHERE (%(faction)s IS NULL OR p.god = %(faction)s)
        AND (%(start_date)s IS NULL OR br.created_at >= %(start_date)s)
        AND (%(end_date)s IS NULL OR br.created_at <= %(end_date)s)
        GROUP BY p.id
    )
    SELECT 
        player_id, 
        player_name, 
        player_faction, 
        battles, 
        kills, 
        deaths,
        (kills * 3 - deaths) AS score
    FROM player_stats
    ORDER BY score DESC, kills DESC, deaths ASC
    LIMIT %(limit)s
    ]
[parameters: {'faction': None, 'start_date': None, 'end_date': None, 'limit': 100}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 09:52:04,256] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:52:04,263] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:52:04,372] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:52:04,453] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:52:04,515] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:52:04,516] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:52:04,535] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:52:04,535] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:52:04,536] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:52:27,183] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:52:27,183] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:52:27,229] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 09:54:07,971] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:54:07,971] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:54:08,015] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 09:54:17,234] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:54:17,238] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:54:17,401] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:54:17,563] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:54:17,648] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:54:17,649] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:54:17,671] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:54:17,671] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:54:17,672] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:54:36,267] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:54:36,270] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:54:36,394] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:54:36,469] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:54:36,528] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:54:36,529] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:54:36,565] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:54:36,566] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:54:36,566] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:54:38,833] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:54:38,872] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:54:39,220] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:54:39,387] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:54:39,516] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:54:39,517] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:54:39,550] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:54:39,552] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:54:39,553] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:54:39,743] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:54:39,744] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:54:39,794] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 09:54:43,150] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:54:43,151] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:54:43,196] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 09:54:47,532] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:54:47,533] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:54:47,578] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 09:54:49,505] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:54:49,506] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:54:49,553] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 09:56:28,932] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:56:28,947] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:56:29,183] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:56:29,337] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:56:29,443] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:56:29,445] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:56:29,466] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:56:29,467] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:56:29,467] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:58:04,464] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:58:04,471] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:58:04,629] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:58:04,779] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:58:04,845] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:58:04,846] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:58:04,859] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:58:04,860] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:58:04,861] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 09:58:17,380] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 09:58:17,382] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 09:58:17,430] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 09:58:17,431] [ERROR] [battle:rankings:146] - 玩家排名页面渲染出错: too many values to unpack (expected 5)
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 130, in rankings
    player_rankings, total_count, total_score, total_kills, total_deaths = get_player_rankings(faction=faction)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: too many values to unpack (expected 5)
[2025-03-25 09:58:43,398] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 09:58:43,407] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 09:58:43,611] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 09:58:43,769] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 09:58:43,913] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 09:58:43,914] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 09:58:43,939] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 09:58:43,940] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 09:58:43,941] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:00:43,539] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:00:43,541] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 10:00:43,590] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 10:01:59,408] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:01:59,409] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 10:01:59,452] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 10:02:06,199] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:02:06,200] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:02:06,219] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:02:10,764] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:02:10,764] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 10:02:10,785] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 10:02:13,177] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:02:13,178] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：湿婆, 限制数量：30
[2025-03-25 10:02:13,195] [INFO] [data_service:get_player_rankings:305] - 返回 1 名玩家的排名数据
[2025-03-25 10:02:16,059] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:02:16,062] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 10:02:16,084] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 10:02:17,614] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:02:17,615] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:02:17,639] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:02:19,514] [INFO] [data_service:get_battle_details_by_player:315] - 获取玩家ID 38 的战斗明细
[2025-03-25 10:02:19,548] [INFO] [data_service:get_battle_details_by_player:506] - 返回玩家 ∝小红绳 的战斗明细
[2025-03-25 10:11:32,984] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:11:32,992] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:11:33,186] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:11:33,356] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:11:33,456] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:11:33,457] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:11:33,482] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:11:33,483] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:11:33,484] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:11:37,641] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:11:37,642] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:11:37,661] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:11:40,005] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:11:40,006] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:11:40,031] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:11:41,987] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:11:41,988] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 10:11:42,007] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 10:11:57,314] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:11:57,321] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:11:57,475] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:11:57,576] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:11:57,657] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:11:57,658] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:11:57,674] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:11:57,675] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:11:57,676] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:11:59,814] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:11:59,814] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 10:11:59,837] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 10:28:29,705] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:28:29,706] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 10:28:29,729] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 10:28:32,050] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:28:32,052] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:28:32,074] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:31:41,650] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:31:41,657] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:31:41,789] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:31:41,877] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:31:41,941] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:31:41,942] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:31:41,958] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:31:41,959] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:31:41,960] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:31:52,452] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:31:52,461] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:31:52,587] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:31:52,679] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:31:52,758] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:31:52,759] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:31:52,775] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:31:52,777] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:31:52,777] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:32:25,331] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:32:25,338] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:32:25,472] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:32:25,567] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:32:25,636] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:32:25,637] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:32:25,659] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:32:25,660] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:32:25,661] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:32:45,754] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:32:45,764] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:32:45,969] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:32:46,107] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:32:46,230] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:32:46,231] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:32:46,253] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:32:46,254] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:32:46,255] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:32:47,287] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:32:47,287] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:32:47,306] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:32:47,750] [INFO] [battle:rankings_stats:530] - 访问排名统计数据API
[2025-03-25 10:32:47,752] [ERROR] [battle:rankings_stats:549] - 获取统计数据时出错: get_statistics() got an unexpected keyword argument 'faction'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 538, in rankings_stats
    total_players, total_kills, total_deaths, total_score = get_statistics(faction=faction)
                                                            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
TypeError: get_statistics() got an unexpected keyword argument 'faction'
[2025-03-25 10:33:47,024] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:33:47,025] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:33:47,045] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:33:47,286] [INFO] [battle:rankings_stats:530] - 访问排名统计数据API
[2025-03-25 10:33:47,288] [ERROR] [battle:rankings_stats:549] - 获取统计数据时出错: get_statistics() got an unexpected keyword argument 'faction'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 538, in rankings_stats
    total_players, total_kills, total_deaths, total_score = get_statistics(faction=faction)
                                                            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
TypeError: get_statistics() got an unexpected keyword argument 'faction'
[2025-03-25 10:34:03,705] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:34:03,710] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:34:03,911] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:34:04,053] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:34:04,170] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:34:04,171] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:34:04,219] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:34:04,220] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:34:04,221] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:34:04,390] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:34:04,390] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:34:04,411] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:34:04,638] [INFO] [battle:rankings_stats:530] - 访问排名统计数据API
[2025-03-25 10:34:21,613] [ERROR] [battle:rankings_stats:549] - 获取统计数据时出错: get_statistics() got an unexpected keyword argument 'faction'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 538, in rankings_stats
    total_players, total_kills, total_deaths, total_score = get_statistics(faction=faction)
                                                            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
TypeError: get_statistics() got an unexpected keyword argument 'faction'
[2025-03-25 10:34:21,619] [WARNING] [__init__:after_request:98] - 请求处理缓慢: /battle/rankings/stats, 状态码: 500, 处理时间: 16983ms
[2025-03-25 10:34:26,927] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:34:26,927] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:34:26,946] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:34:27,171] [INFO] [battle:rankings_stats:530] - 访问排名统计数据API
[2025-03-25 10:34:32,343] [ERROR] [battle:rankings_stats:549] - 获取统计数据时出错: get_statistics() got an unexpected keyword argument 'faction'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 538, in rankings_stats
    total_players, total_kills, total_deaths, total_score = get_statistics(faction=faction)
                                                            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
TypeError: get_statistics() got an unexpected keyword argument 'faction'
[2025-03-25 10:35:40,907] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:35:40,908] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:35:40,930] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:35:41,502] [INFO] [battle:rankings_stats:530] - 访问排名统计数据API
[2025-03-25 10:35:41,504] [ERROR] [battle:rankings_stats:549] - 获取统计数据时出错: get_statistics() got an unexpected keyword argument 'faction'
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\battle.py", line 538, in rankings_stats
    def rankings_stats():
    
TypeError: get_statistics() got an unexpected keyword argument 'faction'
[2025-03-25 10:35:56,693] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:35:56,697] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:35:56,869] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:35:56,954] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:35:57,022] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:35:57,023] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:35:57,063] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:35:57,064] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:35:57,064] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:36:04,449] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:36:04,449] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:36:04,472] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:36:04,754] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 10:36:22,992] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 10:38:05,467] [WARNING] [__init__:after_request:98] - 请求处理缓慢: /battle/rankings/stats, 状态码: 200, 处理时间: 118456ms
[2025-03-25 10:39:32,307] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:39:32,311] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:39:32,446] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:39:32,527] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:39:32,592] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:39:32,592] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:39:32,626] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:39:32,627] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:39:32,627] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:39:33,300] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:39:33,300] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:39:33,320] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:39:33,650] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 10:39:47,159] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 10:39:47,195] [WARNING] [__init__:after_request:98] - 请求处理缓慢: /battle/rankings/stats, 状态码: 200, 处理时间: 13547ms
[2025-03-25 10:40:47,511] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:40:47,512] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 10:40:47,536] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 10:40:47,756] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 10:40:47,756] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 10:45:18,638] [INFO] [data_service:get_battle_details_by_player:315] - 获取玩家ID 1032 的战斗明细
[2025-03-25 10:45:18,680] [INFO] [data_service:get_battle_details_by_player:506] - 返回玩家 瞎子耍大弓 的战斗明细
[2025-03-25 10:45:25,931] [INFO] [data_service:get_battle_details_by_player:315] - 获取玩家ID 1 的战斗明细
[2025-03-25 10:45:25,953] [INFO] [data_service:get_battle_details_by_player:506] - 返回玩家 avax 的战斗明细
[2025-03-25 10:45:54,019] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:45:54,020] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 10:45:54,038] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 10:45:54,278] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 10:45:54,279] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 10:45:58,441] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:47:56,382] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:48:01,104] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:48:02,856] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:48:03,907] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:48:05,198] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:48:05,982] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:48:07,796] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:48:09,778] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:48:11,466] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:48:12,577] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:48:13,556] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:48:15,628] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:48:21,889] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-25 10:48:21,889] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-25 的战斗数据
[2025-03-25 10:48:21,894] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-25 的战斗数据
[2025-03-25 10:48:21,895] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250325_20250325_20250325_104821.csv
[2025-03-25 10:48:21,896] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-25 10:48:21,897] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-25 10:48:22,441] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:48:26,729] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:48:37,693] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:48:37,699] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:48:38,042] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:48:38,213] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:48:38,348] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:48:38,349] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:48:38,369] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:48:38,370] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:48:38,371] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:48:39,806] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:49:12,300] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-25 10:49:12,303] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-25 的战斗数据
[2025-03-25 10:49:12,309] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-25 的战斗数据
[2025-03-25 10:49:12,310] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250325_20250325_20250325_104912.csv
[2025-03-25 10:49:12,311] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-25 10:49:12,312] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-25 10:49:12,916] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:49:15,058] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:51:18,166] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:51:29,756] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:51:29,761] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:51:29,890] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:51:29,969] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:51:30,038] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:51:30,038] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:51:30,052] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:51:30,052] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:51:30,052] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:51:30,529] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:51:41,714] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 10:51:44,036] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:52:55,047] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:52:55,048] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 10:52:55,093] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 10:52:55,347] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 10:52:55,348] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 10:52:55,659] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 10:52:55,659] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 10:55:16,870] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:55:16,870] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 10:55:16,913] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 10:55:17,115] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 10:55:17,115] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 10:55:17,390] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 10:55:17,391] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 10:55:20,066] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:55:30,380] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-25 10:55:30,381] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-25 的战斗数据
[2025-03-25 10:55:30,384] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-25 的战斗数据
[2025-03-25 10:55:30,386] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250325_20250325_20250325_105530.csv
[2025-03-25 10:55:30,387] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-25 10:55:30,387] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-25 10:55:30,896] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:55:33,115] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 10:55:33,116] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 10:55:33,166] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 10:55:33,806] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 10:55:33,807] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 10:55:33,807] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 10:55:33,808] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 10:55:35,120] [INFO] [battle:upload_file:40] - 访问文件上传页面
[2025-03-25 10:55:36,805] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-25 10:55:36,806] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-25 的战斗数据
[2025-03-25 10:55:36,808] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-25 的战斗数据
[2025-03-25 10:55:36,809] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250325_20250325_20250325_105536.csv
[2025-03-25 10:55:36,810] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-25 10:55:36,812] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-25 10:55:37,344] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:55:40,702] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:56:07,583] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:56:07,587] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:56:07,694] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:56:07,767] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:56:07,841] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:56:07,842] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:56:07,854] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:56:07,854] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:56:07,855] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:56:11,176] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:57:40,389] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:57:51,354] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 10:57:51,358] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 10:57:51,474] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 10:57:51,561] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 10:57:51,634] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 10:57:51,634] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 10:57:51,647] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 10:57:51,648] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 10:57:51,648] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 10:57:56,636] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 10:59:31,906] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 11:03:29,219] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 11:03:29,265] [ERROR] [home:index:82] - 生成首页仪表盘时出错: 'faction_player_counts' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    # 获取击杀榜前三
          ^^^^^^^^^^
    ...<7 lines>...
            })
            ^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 150, in block 'content'
    <div class="stat-value">{{ faction_player_counts.get('梵天', 0) }}</div>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'faction_player_counts' is undefined
[2025-03-25 11:03:29,284] [CRITICAL] [__init__:handle_exception:120] - 未处理的异常: 'faction_player_counts' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    # 获取击杀榜前三
          ^^^^^^^^^^
    ...<7 lines>...
            })
            ^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 150, in block 'content'
    <div class="stat-value">{{ faction_player_counts.get('梵天', 0) }}</div>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'faction_player_counts' is undefined

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\auth.py", line 12, in decorated_function
    return f(*args, **kwargs)
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
    # 获取得分榜前三
          ^^^^^^^^^^
    ...<7 lines>...
            })
            ^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 150, in block 'content'
    <div class="stat-value">{{ faction_player_counts.get('梵天', 0) }}</div>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'faction_player_counts' is undefined
[2025-03-25 11:04:45,615] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 11:04:45,619] [ERROR] [home:index:82] - 生成首页仪表盘时出错: 'faction_player_counts' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
        '比湿奴': '#4d94ff',
           ^^^^^^^^^^^^^^^^^
    ...<7 lines>...
            top_killers.append({
            ^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 150, in block 'content'
    <div class="stat-value">{{ faction_player_counts.get('梵天', 0) }}</div>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'faction_player_counts' is undefined
[2025-03-25 11:04:45,635] [CRITICAL] [__init__:handle_exception:120] - 未处理的异常: 'faction_player_counts' is undefined
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
        '比湿奴': '#4d94ff',
           ^^^^^^^^^^^^^^^^^
    ...<7 lines>...
            top_killers.append({
            ^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 150, in block 'content'
    <div class="stat-value">{{ faction_player_counts.get('梵天', 0) }}</div>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'faction_player_counts' is undefined

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\auth.py", line 12, in decorated_function
    return f(*args, **kwargs)
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
            })
    ...<7 lines>...
            top_scorers.append({
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 137, in top-level template code
    {% block content %}{% endblock %}
    ^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 150, in block 'content'
    <div class="stat-value">{{ faction_player_counts.get('梵天', 0) }}</div>
    
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 490, in getattr
    return getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'faction_player_counts' is undefined
[2025-03-25 11:06:22,651] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 11:06:22,685] [ERROR] [home:index:82] - 生成首页仪表盘时出错: Object of type Undefined is not JSON serializable
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    for faction, stats in faction_stats:
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    top_killers = top_killers[:3]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 141, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 260, in block 'scripts'
    data: {{ faction_names|tojson }},
    ^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1721, in do_tojson
    return htmlsafe_json_dumps(value, dumps=dumps, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\utils.py", line 669, in htmlsafe_json_dumps
    dumps(obj, **kwargs)
    ~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 230, in dumps
    return json.dumps(obj, **kwargs)
           ~~~~~~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\__init__.py", line 238, in dumps
    **kw).encode(obj)
          ~~~~~~^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 200, in encode
    chunks = self.iterencode(o, _one_shot=True)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 261, in iterencode
    return _iterencode(o, 0)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 122, in _default
    raise TypeError(f"Object of type {type(o).__name__} is not JSON serializable")
TypeError: Object of type Undefined is not JSON serializable
[2025-03-25 11:06:22,703] [CRITICAL] [__init__:handle_exception:120] - 未处理的异常: Object of type Undefined is not JSON serializable
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    for faction, stats in faction_stats:
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    top_killers = top_killers[:3]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 141, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 260, in block 'scripts'
    data: {{ faction_names|tojson }},
    ^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1721, in do_tojson
    return htmlsafe_json_dumps(value, dumps=dumps, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\utils.py", line 669, in htmlsafe_json_dumps
    dumps(obj, **kwargs)
    ~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 230, in dumps
    return json.dumps(obj, **kwargs)
           ~~~~~~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\__init__.py", line 238, in dumps
    **kw).encode(obj)
          ~~~~~~^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 200, in encode
    chunks = self.iterencode(o, _one_shot=True)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 261, in iterencode
    return _iterencode(o, 0)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 122, in _default
    raise TypeError(f"Object of type {type(o).__name__} is not JSON serializable")
TypeError: Object of type Undefined is not JSON serializable

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\auth.py", line 12, in decorated_function
    return f(*args, **kwargs)
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
    for faction, stats in faction_stats:
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    top_scorers = top_scorers[:3]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 141, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 260, in block 'scripts'
    data: {{ faction_names|tojson }},
    ^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1721, in do_tojson
    return htmlsafe_json_dumps(value, dumps=dumps, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\utils.py", line 669, in htmlsafe_json_dumps
    dumps(obj, **kwargs)
    ~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 230, in dumps
    return json.dumps(obj, **kwargs)
           ~~~~~~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\__init__.py", line 238, in dumps
    **kw).encode(obj)
          ~~~~~~^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 200, in encode
    chunks = self.iterencode(o, _one_shot=True)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 261, in iterencode
    return _iterencode(o, 0)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 122, in _default
    raise TypeError(f"Object of type {type(o).__name__} is not JSON serializable")
TypeError: Object of type Undefined is not JSON serializable
[2025-03-25 11:06:24,289] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 11:06:24,302] [ERROR] [home:index:82] - 生成首页仪表盘时出错: Object of type Undefined is not JSON serializable
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    for faction, stats in faction_stats:
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    top_killers = top_killers[:3]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 141, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 260, in block 'scripts'
    data: {{ faction_names|tojson }},
    ^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1721, in do_tojson
    return htmlsafe_json_dumps(value, dumps=dumps, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\utils.py", line 669, in htmlsafe_json_dumps
    dumps(obj, **kwargs)
    ~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 230, in dumps
    return json.dumps(obj, **kwargs)
           ~~~~~~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\__init__.py", line 238, in dumps
    **kw).encode(obj)
          ~~~~~~^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 200, in encode
    chunks = self.iterencode(o, _one_shot=True)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 261, in iterencode
    return _iterencode(o, 0)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 122, in _default
    raise TypeError(f"Object of type {type(o).__name__} is not JSON serializable")
TypeError: Object of type Undefined is not JSON serializable
[2025-03-25 11:06:24,322] [CRITICAL] [__init__:handle_exception:120] - 未处理的异常: Object of type Undefined is not JSON serializable
Traceback (most recent call last):
  File "C:\coding\kongbai\app\routes\home.py", line 71, in index
    for faction, stats in faction_stats:
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    top_killers = top_killers[:3]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 141, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 260, in block 'scripts'
    data: {{ faction_names|tojson }},
    ^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1721, in do_tojson
    return htmlsafe_json_dumps(value, dumps=dumps, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\utils.py", line 669, in htmlsafe_json_dumps
    dumps(obj, **kwargs)
    ~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 230, in dumps
    return json.dumps(obj, **kwargs)
           ~~~~~~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\__init__.py", line 238, in dumps
    **kw).encode(obj)
          ~~~~~~^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 200, in encode
    chunks = self.iterencode(o, _one_shot=True)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 261, in iterencode
    return _iterencode(o, 0)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 122, in _default
    raise TypeError(f"Object of type {type(o).__name__} is not JSON serializable")
TypeError: Object of type Undefined is not JSON serializable

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1823, in full_dispatch_request
    rv = self.dispatch_request()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\app.py", line 1799, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\utils\auth.py", line 12, in decorated_function
    return f(*args, **kwargs)
  File "C:\coding\kongbai\app\routes\home.py", line 83, in index
    for faction, stats in faction_stats:
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    top_scorers = top_scorers[:3]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 147, in render_template
    return _render(app, template, context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\templating.py", line 130, in _render
    rv = template.render(context)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 1295, in render
    self.environment.handle_exception()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "C:\coding\kongbai\app\templates\home\index.html", line 1, in top-level template code
    {% extends "base.html" %}
  File "C:\coding\kongbai\app\templates\base.html", line 141, in top-level template code
    {% block scripts %}{% endblock %}
    ^^^^^^^^^^^^^^^^^^^^^
  File "C:\coding\kongbai\app\templates\home\index.html", line 260, in block 'scripts'
    data: {{ faction_names|tojson }},
    ^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\filters.py", line 1721, in do_tojson
    return htmlsafe_json_dumps(value, dumps=dumps, **kwargs)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\jinja2\utils.py", line 669, in htmlsafe_json_dumps
    dumps(obj, **kwargs)
    ~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 230, in dumps
    return json.dumps(obj, **kwargs)
           ~~~~~~~~~~^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\__init__.py", line 238, in dumps
    **kw).encode(obj)
          ~~~~~~^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 200, in encode
    chunks = self.iterencode(o, _one_shot=True)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 261, in iterencode
    return _iterencode(o, 0)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\flask\json\provider.py", line 122, in _default
    raise TypeError(f"Object of type {type(o).__name__} is not JSON serializable")
TypeError: Object of type Undefined is not JSON serializable
[2025-03-25 11:06:49,584] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 11:06:53,294] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = CURDATE()
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 11:06:54,535] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND DATE(br.publish_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 11:06:55,406] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 11:06:56,330] [ERROR] [data_service:get_faction_stats:163] - 获取势力统计数据时出错: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1054, "Unknown column 'br.publish_at' in 'where clause'")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\coding\kongbai\app\services\data_service.py", line 137, in get_faction_stats
    result = db.session.execute(stats_query, {'faction': faction}).fetchone()
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\scoping.py", line 779, in execute
    return self._proxied.execute(
           ~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py", line 2260, in _execute_internal
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 516, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 942, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
    ~~~~~~~~~~^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 825, in _read_query_result
    result.read()
    ~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\connections.py", line 775, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "c:\Users\me\AppData\Local\Programs\Python\Python313\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'br.publish_at' in 'where clause'")
[SQL: 
                WITH player_stats AS (
                    SELECT 
                        p.id,
                        p.name,
                        p.god as faction,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as kills,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as deaths,
                        (
                            SELECT sum(remark)
                            FROM battle_record br3
                            WHERE br3.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as blessings,
                        (
                            SELECT COUNT(*) 
                            FROM battle_record br2 
                            WHERE br2.win = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) * 3 - (
                            SELECT COUNT(*) 
                            FROM battle_record br3 
                            WHERE br3.lost = p.name
                            AND br.publish_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                        ) as score
                    FROM person p
                    WHERE p.god = %(faction)s
                )
                SELECT
                    COUNT(DISTINCT id) as player_count,
                    COALESCE(SUM(kills), 0) as total_kills,
                    COALESCE(SUM(deaths), 0) as total_deaths,
                    COALESCE(SUM(blessings), 0) as total_blessings,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_name,
                    (
                        SELECT kills 
                        FROM player_stats 
                        ORDER BY kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_killer_kills,
                    (
                        SELECT name 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_name,
                    (
                        SELECT score 
                        FROM player_stats 
                        ORDER BY score DESC, kills DESC, deaths ASC 
                        LIMIT 1
                    ) as top_scorer_score
                FROM player_stats
            ]
[parameters: {'faction': '梵天'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
[2025-03-25 11:06:57,715] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 11:06:59,537] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 11:06:59,538] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 11:06:59,582] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 11:06:59,798] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 11:06:59,799] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 11:07:00,104] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 11:07:00,105] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 11:07:08,238] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 11:07:08,238] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 11:07:08,258] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 11:07:08,528] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 11:07:08,529] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 11:07:08,831] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 11:07:08,831] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 11:07:12,838] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 11:07:12,839] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 11:07:12,860] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 11:07:13,097] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 11:07:13,098] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 11:07:13,337] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 11:07:13,337] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 11:07:14,894] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 11:07:14,894] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：湿婆, 限制数量：30
[2025-03-25 11:07:14,911] [INFO] [data_service:get_player_rankings:305] - 返回 1 名玩家的排名数据
[2025-03-25 11:07:15,376] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 11:07:15,379] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 11:07:15,379] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 11:07:15,379] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 11:41:22,422] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 11:41:22,432] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 11:41:22,666] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 11:41:22,801] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 11:41:22,888] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 11:41:22,889] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 11:41:22,906] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 11:41:22,907] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 11:41:22,908] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 11:41:29,464] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 11:46:35,824] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 11:46:35,829] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 11:46:35,988] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 11:46:36,076] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 11:46:36,147] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 11:46:36,148] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 11:46:36,163] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 11:46:36,164] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 11:46:36,164] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 11:46:36,652] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 11:46:39,248] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 11:46:39,249] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 11:46:39,293] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 11:46:39,895] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 11:46:39,896] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 11:46:39,896] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 11:46:39,897] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 11:46:43,623] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 11:46:43,624] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 11:46:43,643] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 11:46:44,142] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 11:46:44,143] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 11:46:44,143] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 11:46:44,143] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 11:46:47,044] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 11:46:47,045] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 11:46:47,065] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 11:46:47,543] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 11:46:47,545] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 11:46:47,545] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 11:46:47,545] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 11:46:48,391] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 11:46:48,392] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：湿婆, 限制数量：30
[2025-03-25 11:46:48,411] [INFO] [data_service:get_player_rankings:305] - 返回 1 名玩家的排名数据
[2025-03-25 11:46:48,888] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 11:46:48,889] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 11:46:48,890] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 11:46:48,890] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 11:46:50,273] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 11:46:50,274] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 11:46:50,299] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 11:46:50,998] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 11:46:50,999] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 11:46:50,999] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 11:46:51,000] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 11:50:45,096] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 11:50:45,101] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 11:50:45,313] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 11:50:45,395] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 11:51:11,605] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 11:51:11,609] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 11:51:11,740] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 11:51:11,867] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 12:04:17,823] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 12:04:17,829] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 12:04:17,985] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 12:04:18,090] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 12:06:39,013] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 12:06:39,017] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 12:06:39,159] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 12:06:39,254] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 12:06:39,337] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 12:06:39,338] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 12:06:39,353] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 12:06:39,353] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 12:06:39,354] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 12:07:11,324] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 12:07:11,328] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 12:07:11,503] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 12:07:11,641] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 12:07:11,740] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 12:07:11,741] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 12:07:11,767] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 12:07:11,768] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 12:07:11,769] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 12:07:12,245] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 12:07:12,246] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:44:25,816] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 14:44:25,816] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:47:47,847] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 14:47:47,848] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 14:47:47,895] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 14:47:48,759] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 14:47:48,760] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 14:47:49,072] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 14:47:49,072] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:47:54,889] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 14:47:54,890] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 14:47:54,916] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 14:47:55,258] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 14:47:55,259] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 14:47:55,573] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 14:47:55,573] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:48:01,267] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 14:48:01,268] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 14:48:01,291] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 14:48:01,557] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 14:48:01,559] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 14:48:01,864] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 14:48:01,864] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:48:07,868] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-25 14:48:07,870] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-25 的战斗数据
[2025-03-25 14:48:07,876] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-25 的战斗数据
[2025-03-25 14:48:07,877] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250325_20250325_20250325_144807.csv
[2025-03-25 14:48:07,878] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.01 秒
[2025-03-25 14:48:07,879] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-25 14:48:08,404] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 14:48:08,404] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:48:14,917] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 14:48:14,918] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 14:48:14,962] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 14:48:15,503] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 14:48:15,505] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 14:48:15,505] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 14:48:15,505] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:48:27,319] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 14:48:27,319] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 14:48:27,337] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 14:48:27,861] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 14:48:27,863] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 14:48:27,863] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 14:48:27,863] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:53:20,147] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-25 14:53:20,147] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-25 的战斗数据
[2025-03-25 14:53:20,150] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-25 的战斗数据
[2025-03-25 14:53:20,151] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250325_20250325_20250325_145320.csv
[2025-03-25 14:53:20,152] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.00 秒
[2025-03-25 14:53:20,152] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-25 14:53:20,753] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 14:53:20,754] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:53:43,111] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 14:53:43,111] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 14:53:43,156] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 14:53:43,876] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 14:53:43,878] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 14:53:43,878] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 14:53:43,878] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 14:53:55,228] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 14:53:55,229] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:10:22,745] [INFO] [__init__:create_app:14] - 开始创建Flask应用程序
[2025-03-25 17:10:22,748] [INFO] [__init__:create_app:21] - 应用程序配置已加载，SECRET_KEY: you******
[2025-03-25 17:10:22,897] [INFO] [__init__:create_app:38] - 数据库扩展已初始化
[2025-03-25 17:10:22,967] [INFO] [battle:<module>:28] - 确保上传目录存在: C:\coding\kongbai\uploads
[2025-03-25 17:10:23,030] [INFO] [__init__:create_app:48] - 蓝图已注册: /auth, /battle, /
[2025-03-25 17:10:23,030] [INFO] [__init__:create_app:58] - 检查数据库连接...
[2025-03-25 17:10:23,043] [INFO] [__init__:create_app:62] - 数据库连接正常
[2025-03-25 17:10:23,044] [INFO] [__init__:create_app:123] - 应用程序已启动，环境: development, 调试模式: True
[2025-03-25 17:10:23,044] [INFO] [__init__:create_app:124] - 应用程序配置: UPLOAD_FOLDER=C:\coding\kongbai\uploads, MAX_CONTENT_LENGTH=10485760
[2025-03-25 17:10:34,808] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 17:10:34,808] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:10:40,250] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:10:40,251] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 17:10:40,293] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 17:10:40,900] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:10:40,902] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:10:40,902] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:10:40,902] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:10:44,396] [INFO] [battle_report:generate_battle_report:30] - 开始生成战斗报告
[2025-03-25 17:10:44,398] [INFO] [battle_report:generate_battle_report:73] - 生成报告的日期范围: 2025-03-25 的战斗数据
[2025-03-25 17:10:44,400] [INFO] [battle_report:generate_battle_report:159] - 查询到 0 名玩家的战斗数据.2025-03-25 的战斗数据
[2025-03-25 17:10:44,401] [INFO] [battle_report:generate_battle_report:172] - 战斗报告已保存为CSV文件: C:\coding\kongbai\app\static\reports\battle_report_20250325_20250325_20250325_171044.csv
[2025-03-25 17:10:44,401] [INFO] [battle_report:generate_battle_report:296] - 战斗报告生成完成，处理时间: 0.00 秒
[2025-03-25 17:10:44,403] [ERROR] [battle:report:279] - 生成报告时出错: battle/report.html
[2025-03-25 17:10:45,013] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 17:10:45,013] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:10:46,957] [INFO] [battle:upload_file:40] - 访问文件上传页面
[2025-03-25 17:10:49,453] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:10:49,453] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 17:10:49,494] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 17:10:49,712] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:10:49,713] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:10:49,930] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:10:49,930] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:10:53,014] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 17:10:53,014] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:10:58,890] [WARNING] [__init__:page_not_found:109] - 404 错误: /index, 来源: None
[2025-03-25 17:11:01,304] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 17:11:01,305] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:11:06,321] [WARNING] [__init__:page_not_found:109] - 404 错误: /index.html, 来源: None
[2025-03-25 17:11:08,127] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 17:11:08,128] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:12:30,790] [INFO] [data_service:get_faction_stats:159] - 返回 3 个势力的统计数据
[2025-03-25 17:12:30,790] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:12:40,611] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:12:40,611] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 17:12:40,654] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 17:12:41,097] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:12:41,098] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:12:41,098] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:12:41,098] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:12:43,968] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:12:43,968] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 17:12:43,986] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 17:12:44,493] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:12:44,495] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:12:44,495] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:12:44,495] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:12:46,583] [INFO] [data_service:get_battle_details_by_player:315] - 获取玩家ID 1032 的战斗明细
[2025-03-25 17:12:46,603] [INFO] [data_service:get_battle_details_by_player:506] - 返回玩家 瞎子耍大弓 的战斗明细
[2025-03-25 17:12:56,777] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:12:56,777] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 17:12:56,796] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 17:12:57,037] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:12:57,037] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:12:57,266] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:12:57,266] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:13:11,287] [INFO] [data_service:get_battle_details_by_player:315] - 获取玩家ID 38 的战斗明细
[2025-03-25 17:13:11,295] [INFO] [data_service:get_battle_details_by_player:506] - 返回玩家 ∝小红绳 的战斗明细
[2025-03-25 17:30:13,050] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:13,050] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 17:30:13,093] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 17:30:13,534] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:13,534] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:13,844] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:13,844] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:30:15,829] [INFO] [battle:upload_file:40] - 访问文件上传页面
[2025-03-25 17:30:22,892] [INFO] [battle:upload_file:40] - 访问文件上传页面
[2025-03-25 17:30:22,892] [INFO] [battle:upload_file:43] - 收到文件上传请求
[2025-03-25 17:30:22,897] [INFO] [battle:upload_file:58] - 收到上传文件: ChatLog_2025_3_20_0.txt
[2025-03-25 17:30:22,900] [INFO] [battle:upload_file:71] - 文件已保存到: C:\coding\kongbai\uploads\ChatLog_2025_3_20_0.txt
[2025-03-25 17:30:22,901] [INFO] [battle:upload_file:78] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_20_0.txt
[2025-03-25 17:30:22,901] [INFO] [file_parser:parse_text_file:53] - 开始解析文件: C:\coding\kongbai\uploads\ChatLog_2025_3_20_0.txt
[2025-03-25 17:30:22,902] [INFO] [file_parser:parse_text_file:62] - 文件大小: 67884 字节
[2025-03-25 17:30:22,904] [INFO] [file_parser:parse_text_file:80] - 成功读取文件，共 1031 行
[2025-03-25 17:30:22,905] [INFO] [file_parser:parse_battle_log:117] - 开始解析日志内容
[2025-03-25 17:30:22,905] [INFO] [file_parser:parse_battle_log:122] - 日志共 1030 行
[2025-03-25 17:30:22,908] [INFO] [file_parser:parse_battle_log:196] - 解析完成，共找到 414 条击杀记录和 2 条祝福记录
[2025-03-25 17:30:22,913] [INFO] [battle:upload_file:88] - 文件解析成功: 成功解析 414 条击杀记录和 2 条祝福记录
[2025-03-25 17:30:22,913] [INFO] [battle:upload_file:90] - 开始将解析结果保存到数据库
[2025-03-25 17:30:22,913] [INFO] [file_parser:save_battle_log_to_db:209] - 开始保存战斗日志到数据库: 414条击杀记录, 2条祝福记录
[2025-03-25 17:30:22,913] [INFO] [file_parser:save_battle_log_to_db:212] - 开始保存战斗日志到数据库
[2025-03-25 17:30:22,913] [INFO] [file_parser:save_battle_log_to_db:224] - 战斗日志中共涉及 51 名玩家
[2025-03-25 17:30:22,927] [INFO] [file_parser:save_battle_log_to_db:231] - 数据库中查询到 1036 名玩家记录
[2025-03-25 17:30:22,928] [INFO] [file_parser:save_battle_log_to_db:240] - 战斗日志中的玩家在数据库中找到 49/51 个，缺少 2 个
[2025-03-25 17:30:22,928] [WARNING] [file_parser:save_battle_log_to_db:242] - 以下玩家在数据库中不存在: 沿途有你, 薇う风
[2025-03-25 17:30:22,938] [INFO] [file_parser:save_battle_log_to_db:263] - 检查到 336 条已存在的战斗记录时间戳
[2025-03-25 17:30:22,939] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 薇う风 在数据库中不存在
[2025-03-25 17:30:22,939] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 薇う风 在数据库中不存在
[2025-03-25 17:30:22,939] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 薇う风 在数据库中不存在
[2025-03-25 17:30:22,940] [WARNING] [file_parser:save_battle_log_to_db:308] - 受害者 薇う风 在数据库中不存在
[2025-03-25 17:30:22,940] [WARNING] [file_parser:save_battle_log_to_db:306] - 击杀者 薇う风 在数据库中不存在
[2025-03-25 17:30:22,944] [INFO] [file_parser:save_battle_log_to_db:312] - 战斗记录处理完成：成功 0，错误 0，缺少玩家 59，跳过 355
[2025-03-25 17:30:22,948] [INFO] [file_parser:save_battle_log_to_db:328] - 检查到 2 条已存在的祝福记录时间戳
[2025-03-25 17:30:22,951] [INFO] [file_parser:save_battle_log_to_db:386] - 祝福记录处理完成：成功 0，错误 0，缺少玩家 0
[2025-03-25 17:30:22,952] [INFO] [file_parser:save_battle_log_to_db:433] - 生成战绩报告SQL:
[2025-03-25 17:30:22,952] [INFO] [file_parser:save_battle_log_to_db:434] - 
            WITH player_stats AS (
                SELECT 
                    p.id,
                    p.name,
                    p.job,
                    p.god,
                    -- 统计击杀次数(通过win字段关联)
                    COUNT(DISTINCT CASE WHEN br.win = p.name THEN br.id END) as kills,
                    -- 统计死亡次数(通过lost字段关联)
                    COUNT(DISTINCT CASE WHEN br.lost = p.name THEN br.id END) as deaths,
                    -- 统计祝福次数(只有win的玩家才会有祝福)
                    SUM(CASE WHEN br.win = p.name THEN COALESCE(br.remark, 0) ELSE 0 END) as blessings,
                    -- 获取最后战斗位置和时间
                    MAX(br.position) as last_position,
                    MAX(br.publish_at) as last_battle_time
                FROM 
                    person p
                LEFT JOIN 
                    battle_record br ON br.win = p.name OR br.lost = p.name
                WHERE 1=1
                GROUP BY 
                    p.id, p.name, p.job, p.god
            )
            SELECT 
                id as player_id,
                name as player_name,
                job as player_job,
                god as player_god,
                kills,
                deaths,
                blessings,
                CASE WHEN deaths > 0 
                     THEN ROUND(CAST(kills AS FLOAT) / deaths, 2) 
                     ELSE kills END as kd_ratio,
                (kills * 3 + blessings - deaths) as score,
                last_position,
                last_battle_time
            FROM 
                player_stats
            ORDER BY 
                score DESC, kills DESC, deaths ASC;
            
[2025-03-25 17:30:22,955] [INFO] [file_parser:save_battle_log_to_db:440] - 战斗日志保存完成，总处理时间: 0.04 秒
[2025-03-25 17:30:22,958] [INFO] [battle:upload_file:94] - 数据保存成功: 处理完成：0 条战斗记录，0 条祝福记录
[2025-03-25 17:30:23,272] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:23,273] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 17:30:23,315] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 17:30:23,530] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:23,530] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:23,760] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:23,760] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:30:26,842] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:26,842] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：梵天, 限制数量：30
[2025-03-25 17:30:26,858] [INFO] [data_service:get_player_rankings:305] - 返回 19 名玩家的排名数据
[2025-03-25 17:30:27,306] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:27,308] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:27,308] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:27,309] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:30:31,445] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:31,445] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 17:30:31,462] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 17:30:31,919] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:31,920] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:31,921] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:31,921] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:30:40,457] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:40,457] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 17:30:40,498] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 17:30:40,955] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:40,956] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:40,956] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:40,956] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:30:41,684] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:41,685] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 17:30:41,706] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 17:30:42,145] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:42,146] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:42,146] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:42,146] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:30:50,275] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:50,276] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：None, 限制数量：30
[2025-03-25 17:30:50,319] [INFO] [data_service:get_player_rankings:305] - 返回 30 名玩家的排名数据
[2025-03-25 17:30:50,768] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:50,770] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:50,770] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:50,770] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:30:52,029] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:52,029] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 17:30:52,046] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 17:30:52,500] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:52,501] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:52,501] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:52,501] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:30:52,915] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:52,916] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：湿婆, 限制数量：30
[2025-03-25 17:30:52,932] [INFO] [data_service:get_player_rankings:305] - 返回 1 名玩家的排名数据
[2025-03-25 17:30:53,390] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:53,392] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:53,393] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:53,393] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
[2025-03-25 17:30:53,842] [INFO] [battle:rankings:122] - 访问玩家排名页面
[2025-03-25 17:30:53,842] [INFO] [data_service:get_player_rankings:215] - 获取玩家排名，势力筛选：比湿奴, 限制数量：30
[2025-03-25 17:30:53,860] [INFO] [data_service:get_player_rankings:305] - 返回 29 名玩家的排名数据
[2025-03-25 17:30:54,292] [INFO] [battle:rankings_stats:540] - 访问排名统计数据API
[2025-03-25 17:30:54,293] [INFO] [battle:rankings_faction_stats:607] - 访问势力统计数据API
[2025-03-25 17:30:54,293] [INFO] [battle:get_statistics:503] - 获取总统计数据
[2025-03-25 17:30:54,293] [INFO] [battle:get_faction_statistics:567] - 获取各个势力的统计数据
